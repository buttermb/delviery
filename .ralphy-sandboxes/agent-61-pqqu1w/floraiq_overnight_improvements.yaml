# ============================================================================
# FLORAIQ OVERNIGHT IMPROVEMENT ROADMAP
# Created: 2026-01-23
# Purpose: Comprehensive overnight task list for system improvements
# Priority: Critical issues first, then enhancements
# ============================================================================

metadata:
  project: FloraIQ Delivery Platform
  version: "2.0.0"
  created: "2026-01-23T07:44:00-08:00"
  estimated_duration: "8-12 hours"
  agent_instructions: |
    Execute tasks in priority order. Each task includes acceptance criteria.
    Run verification steps after completing each section before moving to next.
    Log all changes and create commits after each major section completion.

# ============================================================================
# SECTION 1: AUTHENTICATION SYSTEM FIXES (CRITICAL)
# ============================================================================
authentication:
  priority: 1
  estimated_time: "3-4 hours"
  description: |
    Fix auth login/logout issues related to Supabase integration.
    The TenantAdminAuthContext (1753 lines) is overly complex and has race conditions.
  
  issues:
    - id: AUTH-001
      title: "Token refresh race conditions"
      severity: critical
      file: "src/contexts/TenantAdminAuthContext.tsx"
      lines: "741-860"
      problem: |
        The refreshAuthToken function has nested async operations that can cause
        race conditions when multiple components trigger refresh simultaneously.
      solution: |
        1. Add mutex/lock mechanism to prevent concurrent refreshes
        2. Implement request queuing for token refresh
        3. Add debouncing to refresh triggers
      acceptance_criteria:
        - No duplicate refresh requests in network tab
        - Token refresh completes within 3 seconds
        - No "unauthorized" errors during refresh window
      code_changes:
        - Add useRef for refresh lock: `const refreshLockRef = useRef(false)`
        - Add request queue: `const refreshQueueRef = useRef<Promise<boolean> | null>(null)`
        - Modify refreshAuthToken to check/set lock before proceeding

    - id: AUTH-002
      title: "Session persistence on page reload"
      severity: critical
      files:
        - "src/contexts/AuthContext.tsx"
        - "src/contexts/TenantAdminAuthContext.tsx"
      problem: |
        Users are being logged out on page reload due to timing issues between
        Supabase session restoration and component initialization.
      solution: |
        1. Add loading state that blocks rendering until session is verified
        2. Implement proper session hydration from localStorage
        3. Add session validation before clearing user state
      acceptance_criteria:
        - Page reload maintains logged-in state
        - No flash of login screen for authenticated users
        - Session persists across browser tabs

    - id: AUTH-003
      title: "Logout cleanup incomplete"
      severity: high
      file: "src/contexts/TenantAdminAuthContext.tsx"
      lines: "1418-1465"
      problem: |
        Logout doesn't properly clear all auth-related state, causing stale data
        issues when a different user logs in.
      solution: |
        1. Clear all localStorage/sessionStorage auth keys
        2. Reset all React Query caches on logout
        3. Clear encryption keys from clientEncryption
        4. Invalidate any active WebSocket connections
      acceptance_criteria:
        - All storage cleared after logout
        - No stale user data visible after re-login
        - React Query cache cleared completely
      code_changes:
        - Add: `queryClient.clear()` after signOut
        - Add: Clear all STORAGE_KEYS values
        - Add: Reset connection status to 'disconnected'

    - id: AUTH-004
      title: "MFA verification flow broken"
      severity: high
      file: "src/contexts/TenantAdminAuthContext.tsx"
      lines: "1162-1194"
      problem: |
        MFA verification code is not forwarding to the correct endpoint
        and lacks proper error feedback.
      solution: |
        1. Verify MFA endpoint URL is correct
        2. Add proper error message extraction
        3. Implement retry mechanism for transient failures
        4. Add loading state during verification
      acceptance_criteria:
        - MFA codes are validated correctly
        - Error messages are user-friendly
        - Loading indicator shows during verification

    - id: AUTH-005
      title: "Supabase onAuthStateChange memory leak"
      severity: medium
      file: "src/contexts/AuthContext.tsx"
      lines: "43-66"
      problem: |
        Multiple subscriptions can accumulate if AuthProvider remounts.
      solution: |
        1. Ensure subscription cleanup in useEffect return
        2. Add mounted flag to prevent state updates after unmount
        3. Consider using useCallback for event handlers
      acceptance_criteria:
        - No memory leaks in React DevTools
        - Single subscription per provider instance

  verification:
    automated_tests:
      - command: "npm run test -- --grep 'TenantAdminAuthContext'"
        file: "src/contexts/__tests__/TenantAdminAuthContext.test.tsx"
        expected: "All tests pass"
      - command: "npm run test -- --grep 'auth'"
        expected: "No auth-related test failures"
    
    manual_tests:
      - name: "Login flow"
        steps:
          - "1. Navigate to /tenant-login"
          - "2. Enter valid credentials"
          - "3. Verify redirect to dashboard"
          - "4. Refresh page - should stay logged in"
          - "5. Open new tab - should be logged in"
      - name: "Logout flow"
        steps:
          - "1. Click logout button"
          - "2. Verify redirect to login page"
          - "3. Check localStorage is cleared (DevTools > Application > Storage)"
          - "4. Try to access /admin - should redirect to login"
          - "5. Login as different user - verify no stale data"

# ============================================================================
# SECTION 2: BUSINESS ADMIN PANEL FLOW
# ============================================================================
admin_panel_flow:
  priority: 2
  estimated_time: "2-3 hours"
  description: |
    Verify and fix interconnections between all admin panels.
    Ensure navigation state persists and sidebar reflects current location.
  
  panels_to_audit:
    - path: "/admin"
      component: "AdminLayout.tsx"
      children:
        - "/admin/dashboard" 
        - "/admin/orders"
        - "/admin/products"
        - "/admin/customers"
        - "/admin/storefront/*"
        - "/admin/disposable-menus"
        - "/admin/settings"
        - "/admin/analytics"
        - "/admin/reports"
        - "/admin/automation"

  issues:
    - id: ADMIN-001
      title: "Sidebar active state not reflecting current route"
      severity: medium
      file: "src/components/tenant-admin/TenantAdminSidebar.tsx"
      problem: |
        The sidebar doesn't always highlight the correct section when navigating
        via deep links or after page refresh.
      solution: |
        1. Update route matching logic to handle nested routes
        2. Use useLocation to determine active state
        3. Expand parent sections when child is active
      acceptance_criteria:
        - Sidebar highlights correct item for all routes
        - Parent sections auto-expand when child is active
        - Deep links work correctly

    - id: ADMIN-002
      title: "Breadcrumb navigation incomplete"
      severity: medium
      file: "src/components/admin/Breadcrumbs.tsx"
      problem: |
        Breadcrumbs don't show for all pages, especially nested storefront pages.
      solution: |
        1. Add route-to-breadcrumb mapping for all admin routes
        2. Handle dynamic route parameters (e.g., :storeId)
        3. Make breadcrumb items clickable
      acceptance_criteria:
        - Breadcrumbs show on all admin pages
        - Dynamic routes display proper labels
        - All breadcrumb links are functional

    - id: ADMIN-003
      title: "Page state not preserved on navigation"
      severity: low
      problem: |
        Filters, search queries, and pagination reset when navigating away
        and returning to a page.
      solution: |
        1. Persist filter state to URL search params
        2. Use React Query for data caching
        3. Add session-based state preservation for complex filters
      acceptance_criteria:
        - Filters persist in URL
        - Back button restores previous state
        - Data refreshes in background without UI flash

  panel_verification_checklist:
    - panel: "Dashboard"
      checks:
        - "Stats widgets load with real data"
        - "Quick actions navigate to correct pages"
        - "Recent activity shows latest entries"
    - panel: "Orders"
      checks:
        - "Order list loads with pagination"
        - "Filters work correctly"
        - "Order detail links work"
        - "Status updates reflect in real-time"
    - panel: "Products"
      checks:
        - "Product table loads with bulk actions"
        - "Add/Edit product forms save correctly"
        - "Image uploads work"
        - "Inventory sync is active"
    - panel: "Customers"
      checks:
        - "Customer list with search"
        - "Customer detail view loads"
        - "Order history displays"
        - "Notes/tags can be added"
    - panel: "Storefront"
      checks:
        - "Builder loads and saves"
        - "Live preview works"
        - "Theme changes apply"
        - "Product grid syncs"
    - panel: "Disposable Menus"
      checks:
        - "Menu creation wizard works"
        - "QR codes generate"
        - "Menu sharing dialog opens"
        - "Analytics load"
    - panel: "Settings"
      checks:
        - "All setting sections load"
        - "Changes save properly"
        - "Validation errors show"
        - "Dangerous actions require confirmation"

# ============================================================================
# SECTION 3: DISPOSABLE MENU IMPROVEMENTS
# ============================================================================
disposable_menus:
  priority: 3
  estimated_time: "2 hours"
  description: |
    Enhance the disposable menu feature with better UX and performance.
    Currently has 64+ related files - needs consolidation and optimization.
  
  current_components:
    dialogs:
      - "BurnMenuDialog.tsx"
      - "CloneMenuDialog.tsx"
      - "CreateMenuDialog.tsx"
      - "CreateMenuSimpleDialog.tsx"
      - "MenuShareDialog.tsx"
      - "MenuShareDialogEnhanced.tsx"
      - "MenuPaymentSettingsDialog.tsx"
      - "MenuAnalyticsDialog.tsx"
    core:
      - "EnhancedMenuDashboard.tsx"
      - "MenuCreationWizard.tsx"
      - "MenuWizard.tsx"
      - "MenuCard.tsx"
      - "MenuFilters.tsx"
    analytics:
      - "MenuImageAnalytics.tsx"
      - "MenuStatsCard.tsx"
    customer_facing:
      - "MenuCart.tsx"
      - "MenuList.tsx"
      - "MenuOrderForm.tsx"
      - "MenuProductGrid.tsx"

  improvements:
    - id: MENU-001
      title: "Consolidate duplicate dialog components"
      severity: medium
      problem: |
        CreateMenuDialog and CreateMenuSimpleDialog have overlapping functionality.
        MenuShareDialog and MenuShareDialogEnhanced are confusingly named.
      solution: |
        1. Merge CreateMenuDialog and CreateMenuSimpleDialog into single component
           with a 'simple' mode prop
        2. Rename MenuShareDialogEnhanced to MenuShareDialog and deprecate old one
        3. Update all imports throughout codebase
      acceptance_criteria:
        - Only one CreateMenuDialog exists
        - MenuShareDialog is the only share dialog
        - No broken imports

    - id: MENU-002
      title: "Menu creation wizard UX improvements"
      severity: medium
      file: "src/components/admin/disposable-menus/MenuCreationWizard.tsx"
      problem: |
        The wizard has too many steps and doesn't save progress.
      solution: |
        1. Reduce steps from 5 to 3 (Basic Info, Products, Settings)
        2. Add auto-save draft functionality
        3. Add progress indicator
        4. Add "Quick Create" option for simple menus
      acceptance_criteria:
        - Wizard completes in 3 steps max
        - Progress auto-saves every 30 seconds
        - Quick create generates menu in <10 seconds

    - id: MENU-003
      title: "QR code generation performance"
      severity: low
      problem: |
        QR code generation blocks the UI for large menus.
      solution: |
        1. Move QR generation to web worker
        2. Add caching for generated QR codes
        3. Implement lazy generation (only when viewed)
      acceptance_criteria:
        - QR generation doesn't block UI
        - Previously generated QR codes load instantly
        - No visible lag when opening share dialog

    - id: MENU-004
      title: "Menu analytics real-time updates"
      severity: low
      file: "src/components/admin/disposable-menus/MenuAnalyticsDialog.tsx"
      problem: |
        Analytics don't update in real-time when menu is actively being used.
      solution: |
        1. Add Supabase realtime subscription for menu views/orders
        2. Implement optimistic UI updates
        3. Add refresh button for manual update
      acceptance_criteria:
        - View count updates within 5 seconds of new view
        - Order count updates in real-time
        - Manual refresh button works

    - id: MENU-005
      title: "Mobile menu actions UX"
      severity: medium
      file: "src/components/admin/disposable-menus/MobileMenuActions.tsx"
      problem: |
        Mobile action sheet is cramped and hard to use.
      solution: |
        1. Increase touch target sizes to 44x44px minimum
        2. Group related actions together
        3. Add swipe gestures for common actions (delete, share)
        4. Add haptic feedback on iOS
      acceptance_criteria:
        - All touch targets >= 44x44px
        - Swipe to delete works
        - Actions are logically grouped

  verification:
    automated_tests:
      - command: "npm run test -- --grep 'disposable-menu'"
        expected: "All menu tests pass"
    manual_tests:
      - name: "Menu creation flow"
        steps:
          - "1. Go to /admin/disposable-menus"
          - "2. Click 'Create Menu' button"
          - "3. Complete wizard (should be 3 steps or less)"
          - "4. Verify menu appears in list"
          - "5. Click QR code icon - verify code generates"
          - "6. Open menu link in incognito - verify loads"

# ============================================================================
# SECTION 4: STOREFRONT COMPLETE BUILDOUT
# ============================================================================
storefront:
  priority: 4
  estimated_time: "3-4 hours"
  description: |
    Complete buildout of storefront feature. Currently has 32 related files
    including a 1252-line StorefrontBuilder component that needs optimization.
  
  current_pages:
    admin:
      - "StorefrontAnalytics.tsx" # 8KB - needs real-time data
      - "StorefrontBuilder.tsx" # 62KB - needs refactoring
      - "StorefrontBundles.tsx" # 22KB
      - "StorefrontCoupons.tsx" # 22KB
      - "StorefrontCustomers.tsx" # 14KB
      - "StorefrontDashboard.tsx" # 30KB
      - "StorefrontGiftCards.tsx" # 680B - basically empty!
      - "StorefrontLiveOrders.tsx" # 20KB
      - "StorefrontOrders.tsx" # 20KB
      - "StorefrontProducts.tsx" # 22KB
      - "StorefrontSettings.tsx" # 48KB
    customer_facing:
      - "StorefrontPage.tsx"
      - "StorefrontAgeGate.tsx"
      - "StorefrontDynamicCarousels.tsx"
      - "StorefrontProductCard.tsx"

  improvements:
    - id: STORE-001
      title: "Complete StorefrontGiftCards implementation"
      severity: high
      file: "src/pages/admin/storefront/StorefrontGiftCards.tsx"
      problem: |
        Gift cards page is basically empty (680 bytes).
        Missing core functionality for a storefront feature.
      solution: |
        1. Implement gift card creation form
        2. Add gift card list with search/filter
        3. Add balance check functionality
        4. Add redemption history
        5. Add email delivery for digital gift cards
      acceptance_criteria:
        - Can create gift cards with custom amounts
        - Can search and manage existing gift cards
        - Balance check works
        - Email delivery sends successfully
      features_to_add:
        - GiftCardForm component
        - GiftCardTable with DataTable
        - GiftCardBalanceCheck component
        - GiftCardEmailPreview component

    - id: STORE-002
      title: "StorefrontBuilder refactoring"
      severity: high
      file: "src/pages/admin/storefront/StorefrontBuilder.tsx"
      problem: |
        Component is 1252 lines and hard to maintain.
        Too many responsibilities in one component.
      solution: |
        1. Extract section management into custom hook (useSectionManager)
        2. Extract theme management into custom hook (useThemeManager)
        3. Extract store CRUD into custom hook (useStoreManager)
        4. Create separate components for:
           - BuilderSidebar
           - BuilderPreview
           - BuilderToolbar
           - SectionEditor
        5. Add lazy loading for section components
      acceptance_criteria:
        - Main component < 400 lines
        - Each hook is testable in isolation
        - No performance degradation
        - All existing functionality preserved
      refactoring_plan:
        - "Step 1: Extract useSectionManager hook"
        - "Step 2: Extract useThemeManager hook"
        - "Step 3: Create BuilderSidebar component"
        - "Step 4: Create BuilderPreview component"
        - "Step 5: Create SectionEditor component"
        - "Step 6: Update imports and test"

    - id: STORE-003
      title: "Real-time order updates in LiveOrders"
      severity: medium
      file: "src/pages/admin/storefront/StorefrontLiveOrders.tsx"
      problem: |
        Orders don't update in real-time, requiring manual refresh.
      solution: |
        1. Add Supabase realtime subscription for orders table
        2. Add audio notification for new orders
        3. Add visual indicator (badge/flash) for new orders
        4. Implement optimistic status updates
      acceptance_criteria:
        - New orders appear within 3 seconds
        - Audio plays for new orders (toggleable)
        - Status changes reflect immediately
        - No duplicate order entries

    - id: STORE-004
      title: "Add storefront SEO settings"
      severity: medium
      file: "src/pages/admin/storefront/StorefrontSettings.tsx"
      problem: |
        No SEO configuration options for storefronts.
      solution: |
        1. Add SEO section to settings page
        2. Include: title template, meta description, OG image
        3. Add preview of how store appears in Google/social
        4. Auto-generate sitemap for published stores
      acceptance_criteria:
        - SEO settings save and apply
        - Preview shows accurate representation
        - Sitemap generates correctly
        - OG image uploads and displays

    - id: STORE-005
      title: "Storefront analytics dashboard"
      severity: medium
      file: "src/pages/admin/storefront/StorefrontAnalytics.tsx"
      problem: |
        Analytics page (8KB) lacks depth compared to other pages.
      solution: |
        1. Add revenue charts (daily, weekly, monthly)
        2. Add top products by sales
        3. Add customer acquisition metrics
        4. Add conversion funnel visualization
        5. Add export functionality
      acceptance_criteria:
        - All charts load with real data
        - Date range picker works
        - Export to CSV/PDF works
        - Mobile-responsive charts

    - id: STORE-006
      title: "Add storefront themes/templates"
      severity: low
      file: "src/lib/storefrontThemes.ts"
      problem: |
        Limited theme options for storefronts.
      solution: |
        1. Add 5+ pre-built theme presets
        2. Add theme preview functionality
        3. Add custom CSS injection option
        4. Add font selection (Google Fonts)
      acceptance_criteria:
        - At least 5 theme presets available
        - Themes can be previewed before applying
        - Custom CSS works without breaking layout
        - Font changes apply globally

    - id: STORE-007
      title: "Inventory sync with main catalog"
      severity: high
      file: "src/pages/admin/storefront/StorefrontProducts.tsx"
      problem: |
        Storefront products may get out of sync with main inventory.
      solution: |
        1. Add real-time inventory sync from main catalog
        2. Add low stock warnings on product cards
        3. Auto-hide out-of-stock products option
        4. Add bulk sync trigger button
      acceptance_criteria:
        - Stock levels reflect main inventory
        - Low stock badge shows on cards
        - Auto-hide setting works
        - Bulk sync completes without errors

  verification:
    automated_tests:
      - command: "npm run test -- src/pages/admin/storefront/"
        expected: "All storefront tests pass"
      - command: "npm run test -- src/test/__tests__/storefrontCheckout.test.ts"
        expected: "Checkout tests pass"
    manual_tests:
      - name: "Complete storefront flow"
        steps:
          - "1. Create new storefront"
          - "2. Add products from catalog"
          - "3. Apply a theme"
          - "4. Publish storefront"
          - "5. Visit public URL"
          - "6. Add product to cart"
          - "7. Complete checkout"
          - "8. Verify order appears in LiveOrders"

# ============================================================================
# SECTION 5: GENERAL CODE QUALITY IMPROVEMENTS
# ============================================================================
code_quality:
  priority: 5
  estimated_time: "1 hour"
  description: |
    General improvements for code quality, performance, and maintainability.
  
  tasks:
    - id: QUALITY-001
      title: "Add error boundaries to all major sections"
      severity: medium
      problem: |
        Unhandled errors crash the entire app instead of just the affected section.
      solution: |
        1. Wrap each major route/section in ErrorBoundary
        2. Add fallback UI for each section
        3. Add error reporting to logging service
      files:
        - "src/pages/admin/AdminLayout.tsx"
        - "src/pages/admin/storefront/*.tsx"
        - "src/pages/admin/disposable-menus/*.tsx"

    - id: QUALITY-002
      title: "Implement proper TypeScript strict mode"
      severity: low
      problem: |
        Some files have type errors that are being suppressed.
      solution: |
        1. Enable strict mode in tsconfig
        2. Fix all resulting type errors
        3. Remove all @ts-ignore comments
        4. Add proper types to all function parameters

    - id: QUALITY-003
      title: "Add loading skeletons to all pages"
      severity: low
      problem: |
        Some pages show blank white while loading.
      solution: |
        1. Use existing SkeletonAdminLayout for admin pages
        2. Create section-specific skeletons where needed
        3. Ensure consistent loading experience

    - id: QUALITY-004
      title: "Optimize React Query cache settings"
      severity: low
      problem: |
        Some queries refetch too often, causing unnecessary API calls.
      solution: |
        1. Review staleTime settings for all queries
        2. Add proper cache invalidation on mutations
        3. Implement optimistic updates where appropriate

# ============================================================================
# SECTION 6: TESTING INFRASTRUCTURE
# ============================================================================
testing:
  priority: 6
  estimated_time: "2 hours"
  description: |
    Improve test coverage and testing infrastructure.
    Currently has 20 test directories but many are sparse.
  
  current_test_directories:
    - "src/components/admin/sidebar/__tests__"
    - "src/components/admin/storefront/__tests__"
    - "src/components/credits/__tests__"
    - "src/components/pos/__tests__"
    - "src/contexts/__tests__"
    - "src/hooks/__tests__"
    - "src/lib/__tests__"
    - "src/lib/auth/__tests__"
    - "src/lib/credits/__tests__"
    - "src/lib/edge-functions/__tests__"
    - "src/lib/marketplace/__tests__"
    - "src/lib/pos/__tests__"
    - "src/lib/sidebar/__tests__"
    - "src/lib/supabase/__tests__"
    - "src/pages/admin/__tests__"
    - "src/pages/admin/storefront/__tests__"
    - "src/test/__tests__"

  tasks:
    - id: TEST-001
      title: "Add E2E tests for critical user flows"
      severity: high
      problem: |
        No end-to-end tests for critical paths like checkout, auth, and order management.
      solution: |
        1. Set up Playwright or Cypress for E2E testing
        2. Add tests for: login, checkout, order creation, menu creation
        3. Add tests for admin panel navigation
        4. Set up CI/CD pipeline for E2E tests
      acceptance_criteria:
        - E2E test framework configured
        - 10+ critical path tests written
        - Tests run in CI/CD

    - id: TEST-002
      title: "Increase unit test coverage for hooks"
      severity: medium
      files:
        - "src/hooks/__tests__/"
      problem: |
        189 hooks but limited test coverage.
      solution: |
        1. Prioritize hooks used in auth: useAuth*, useTenant*
        2. Add tests for financial hooks: useCredits, useFinancialData
        3. Add tests for realtime hooks: useRealtimeOrders, useRealtimeSync
      acceptance_criteria:
        - All auth hooks have 80%+ coverage
        - All credit hooks have 80%+ coverage
        - Test runner passes all hooks

    - id: TEST-003
      title: "Add integration tests for Supabase operations"
      severity: medium
      files:
        - "src/lib/supabase/__tests__/"
      problem: |
        Supabase operations are tested in isolation but not end-to-end.
      solution: |
        1. Create test database with seed data
        2. Add integration tests for CRUD operations
        3. Add tests for RLS policies
        4. Add tests for realtime subscriptions
      acceptance_criteria:
        - Test database exists with seed data
        - All tables have CRUD tests
        - RLS policies verified

    - id: TEST-004
      title: "Add visual regression tests for UI components"
      severity: low
      problem: |
        No way to catch UI regressions automatically.
      solution: |
        1. Set up Storybook for component documentation
        2. Add Chromatic or Percy for visual testing
        3. Add tests for key UI components
      acceptance_criteria:
        - Storybook configured with key components
        - Visual regression CI configured

# ============================================================================
# SECTION 7: PERFORMANCE OPTIMIZATION
# ============================================================================
performance:
  priority: 7
  estimated_time: "2 hours"
  description: |
    Optimize application performance, especially for slow pages
    and data-heavy operations.
  
  key_files:
    - "src/lib/performance.ts" # 6KB - existing monitoring
    - "src/lib/react-query-config.ts" # 4KB - cache settings
    - "src/hooks/useOptimizedQuery.ts"
    - "src/hooks/usePrefetch.ts"
    - "src/hooks/usePrefetchDashboard.ts"

  tasks:
    - id: PERF-001
      title: "Optimize large table rendering"
      severity: high
      problem: |
        Product, Order, and Customer tables are slow with 1000+ rows.
      solution: |
        1. Implement virtual scrolling for all DataTables
        2. Add row height caching for smooth scrolling
        3. Lazy load row details on expand
        4. Add pagination as fallback for mobile
      acceptance_criteria:
        - Tables with 5000 rows render in <2 seconds
        - Scroll is smooth (60fps)
        - Memory usage stays under 200MB

    - id: PERF-002
      title: "Implement route-level code splitting"
      severity: medium
      problem: |
        Initial bundle size is too large, affecting first load time.
      solution: |
        1. Lazy load all admin routes
        2. Lazy load shop/storefront routes
        3. Create loading skeletons for each route
        4. Prefetch adjacent routes on hover
      acceptance_criteria:
        - Initial JS bundle < 500KB
        - Route transitions < 300ms
        - Lighthouse performance score > 80

    - id: PERF-003
      title: "Optimize image loading"
      severity: medium
      files:
        - "src/hooks/useOptimizedImage.ts"
        - "src/hooks/useResponsiveImage.ts"
      problem: |
        Product images are loaded at full resolution even on mobile.
      solution: |
        1. Implement responsive image loading with srcset
        2. Add blur placeholder while loading
        3. Add lazy loading with IntersectionObserver
        4. Implement WebP conversion on upload
      acceptance_criteria:
        - Images load at appropriate resolution
        - Blur placeholders show during load
        - Below-fold images lazy load

    - id: PERF-004
      title: "Add database query optimization"
      severity: high
      problem: |
        Some pages make too many Supabase requests.
      solution: |
        1. Audit all useQuery calls for N+1 problems
        2. Combine related queries using Supabase joins
        3. Add proper cache keys for related data
        4. Implement query batching where possible
      acceptance_criteria:
        - Dashboard makes < 10 requests on load
        - Order page makes < 5 requests
        - No N+1 query patterns

    - id: PERF-005
      title: "Implement service worker caching"
      severity: low
      problem: |
        App doesn't cache static assets effectively.
      solution: |
        1. Set up Workbox for service worker
        2. Cache static assets (JS, CSS, images)
        3. Cache API responses where appropriate
        4. Add offline fallback page
      acceptance_criteria:
        - Static assets cached by service worker
        - Repeat visits load instantly
        - Offline page shows when disconnected

# ============================================================================
# SECTION 8: SECURITY HARDENING
# ============================================================================
security:
  priority: 8
  estimated_time: "2 hours"
  description: |
    Enhance security across the application with proper
    input validation, encryption, and access controls.
  
  current_security_files:
    - "src/lib/security/" # Security module directory
    - "src/lib/encryption/clientEncryption.ts"
    - "src/lib/rateLimit.ts"
    - "src/lib/rateLimiter.ts"
    - "src/lib/signupProtection.ts"
    - "src/lib/fingerprint.ts"
    - "src/hooks/useScreenshotProtection.ts"
    - "src/hooks/useDuressMode.ts"

  tasks:
    - id: SEC-001
      title: "Add input sanitization to all forms"
      severity: critical
      files:
        - "src/lib/utils/sanitize.ts"
      problem: |
        Not all user inputs are sanitized before storage or display.
      solution: |
        1. Create centralized sanitization utility
        2. Apply to all form submissions
        3. Sanitize data before rendering (XSS prevention)
        4. Add server-side validation via Edge Functions
      acceptance_criteria:
        - All inputs sanitized before storage
        - XSS attacks blocked
        - SQL injection prevented

    - id: SEC-002
      title: "Implement rate limiting on all API endpoints"
      severity: high
      files:
        - "src/lib/rateLimit.ts"
        - "src/lib/rateLimiter.ts"
      problem: |
        Rate limiting exists but not applied consistently.
      solution: |
        1. Apply rate limiting to all Edge Functions
        2. Add per-user rate limits for sensitive operations
        3. Add IP-based limits for unauthenticated endpoints
        4. Add rate limit headers in responses
      acceptance_criteria:
        - All endpoints rate limited
        - Login attempts limited to 5/minute
        - API calls limited to 100/minute/user

    - id: SEC-003
      title: "Add audit logging for sensitive operations"
      severity: high
      file: "src/lib/auditLog.ts"
      problem: |
        Some sensitive operations aren't logged.
      solution: |
        1. Log all auth events (login, logout, password change)
        2. Log all financial transactions
        3. Log all permission changes
        4. Add log viewer in admin panel
      acceptance_criteria:
        - All auth events logged
        - All transactions logged
        - Logs viewable in admin

    - id: SEC-004
      title: "Implement CSP headers"
      severity: medium
      problem: |
        Content Security Policy not configured.
      solution: |
        1. Add CSP headers in Vercel config
        2. Configure allowed sources for scripts, styles, images
        3. Add report-uri for CSP violations
        4. Test with CSP evaluator
      acceptance_criteria:
        - CSP headers present on all responses
        - No CSP violations in production
        - Violation reports configured

    - id: SEC-005
      title: "Add session timeout and warning"
      severity: medium
      problem: |
        Sessions don't timeout, posing security risk on shared devices.
      solution: |
        1. Implement 30-minute idle timeout
        2. Add 5-minute warning modal before timeout
        3. Add "Stay logged in" option for trusted devices
        4. Force logout on session timeout
      acceptance_criteria:
        - Session times out after 30 min idle
        - Warning shown 5 min before timeout
        - Stay logged in option works

# ============================================================================
# SECTION 9: MOBILE & OFFLINE FEATURES
# ============================================================================
mobile_offline:
  priority: 9
  estimated_time: "2 hours"
  description: |
    Improve mobile experience and add offline capabilities
    for field operations and unreliable connections.
  
  current_mobile_files:
    - "src/hooks/useIsMobile.ts"
    - "src/hooks/use-mobile.tsx"
    - "src/hooks/useMobileGestures.ts"
    - "src/hooks/useMobileNavigation.ts"
    - "src/hooks/useMobileOptimized.ts"
    - "src/lib/mobile-analytics.ts"
    - "src/lib/haptics.ts"
    - "src/lib/capacitor.ts"

  current_offline_files:
    - "src/lib/offlineQueue.ts"
    - "src/lib/idb.ts"
    - "src/lib/sync-queue.ts"
    - "src/hooks/useOfflineQueue.ts"
    - "src/hooks/useNetworkStatus.ts"
    - "src/hooks/useOnlineStatus.ts"

  tasks:
    - id: MOBILE-001
      title: "Fix mobile navigation issues"
      severity: high
      problem: |
        Mobile bottom nav overlaps content on some pages.
      solution: |
        1. Add proper padding-bottom on pages with bottom nav
        2. Fix z-index issues with modals and bottom nav
        3. Add safe-area-inset support for notched devices
        4. Test on iOS and Android simulators
      acceptance_criteria:
        - No content hidden by bottom nav
        - Modals appear above bottom nav
        - Safe areas respected on all devices

    - id: MOBILE-002
      title: "Improve touch interactions"
      severity: medium
      files:
        - "src/hooks/useGestures.ts"
        - "src/hooks/useMobileGestures.ts"
      problem: |
        Touch targets too small, gestures not intuitive.
      solution: |
        1. Ensure all touch targets >= 44x44px
        2. Add pull-to-refresh on list pages
        3. Add swipe actions for common operations
        4. Add long-press context menus
      acceptance_criteria:
        - All touch targets meet size requirements
        - Pull-to-refresh works on all lists
        - Swipe actions work smoothly

    - id: MOBILE-003
      title: "Implement offline order creation"
      severity: high
      files:
        - "src/lib/offlineQueue.ts"
        - "src/hooks/useOfflineQueue.ts"
      problem: |
        Orders can't be created when offline.
      solution: |
        1. Queue orders in IndexedDB when offline
        2. Sync orders when connection restored
        3. Show pending orders badge
        4. Handle sync conflicts gracefully
      acceptance_criteria:
        - Orders save locally when offline
        - Sync happens automatically on reconnect
        - No data loss during sync

    - id: MOBILE-004
      title: "Add offline data caching"
      severity: medium
      file: "src/lib/idb.ts"
      problem: |
        App is unusable when offline.
      solution: |
        1. Cache product catalog in IndexedDB
        2. Cache customer list for offline lookup
        3. Cache menu data for customer-facing pages
        4. Add sync indicator for stale data
      acceptance_criteria:
        - Products viewable offline
        - Customers searchable offline
        - Stale data indicator shows

    - id: MOBILE-005
      title: "Implement push notifications"
      severity: medium
      files:
        - "src/lib/pushNotifications.ts"
        - "src/hooks/usePushNotifications.ts"
      problem: |
        Push notifications configured but not fully implemented.
      solution: |
        1. Complete FCM integration
        2. Add notification for new orders
        3. Add notification for low inventory
        4. Add notification preferences in settings
      acceptance_criteria:
        - Push notifications work on mobile
        - New order notifications received
        - Preferences can be customized

# ============================================================================
# SECTION 10: REALTIME FEATURES
# ============================================================================
realtime:
  priority: 10
  estimated_time: "1.5 hours"
  description: |
    Enhance real-time features using Supabase Realtime
    for live updates across the application.
  
  current_realtime_files:
    - "src/lib/realtime.ts" # 8KB
    - "src/hooks/useRealtimeOrders.ts" # 8KB
    - "src/hooks/useRealtimePOS.ts" # 8KB
    - "src/hooks/useRealtimeSync.ts" # 12KB
    - "src/hooks/useRealtimeTable.ts" # 5KB
    - "src/hooks/useRealtimeTracking.ts" # 4KB
    - "src/hooks/useRealtimeConnectionStatus.ts" # 3KB

  tasks:
    - id: REALTIME-001
      title: "Add realtime inventory updates"
      severity: high
      problem: |
        Inventory levels don't update in real-time between users.
      solution: |
        1. Subscribe to inventory table changes
        2. Update stock levels in real-time
        3. Show notification when stock changes
        4. Handle concurrent edit conflicts
      acceptance_criteria:
        - Stock changes visible within 2 seconds
        - Concurrent edits handled gracefully
        - Low stock alerts trigger in real-time

    - id: REALTIME-002
      title: "Add realtime delivery tracking"
      severity: medium
      files:
        - "src/hooks/useRealtimeTracking.ts"
        - "src/hooks/useLocationTracking.ts"
      problem: |
        Delivery locations don't update live on map.
      solution: |
        1. Subscribe to runner location updates
        2. Animate marker movements on map
        3. Update ETA in real-time
        4. Add geofencing alerts
      acceptance_criteria:
        - Runner locations update every 10 seconds
        - Map markers animate smoothly
        - ETA updates automatically

    - id: REALTIME-003
      title: "Add realtime chat/messaging"
      severity: low
      problem: |
        No real-time communication between admin and customers/runners.
      solution: |
        1. Implement chat using Supabase Realtime
        2. Add chat widget for customer support
        3. Add messaging for runner coordination
        4. Add typing indicators and read receipts
      acceptance_criteria:
        - Messages delivered instantly
        - Typing indicators work
        - Chat history persists

    - id: REALTIME-004
      title: "Improve connection status handling"
      severity: medium
      file: "src/hooks/useRealtimeConnectionStatus.ts"
      problem: |
        App doesn't handle connection drops gracefully.
      solution: |
        1. Add reconnection logic with exponential backoff
        2. Show connection status indicator
        3. Queue operations during disconnection
        4. Resync data on reconnection
      acceptance_criteria:
        - Automatic reconnection works
        - Status indicator visible
        - No data loss during disconnection

# ============================================================================
# SECTION 11: POS SYSTEM ENHANCEMENTS
# ============================================================================
pos_system:
  priority: 11
  estimated_time: "2 hours"
  description: |
    Enhance the Point of Sale system for faster operations
    and better integration with inventory.
  
  current_pos_files:
    - "src/pages/admin/PointOfSale.tsx" # 32KB
    - "src/pages/admin/CashRegister.tsx" # 52KB
    - "src/lib/pos/" # POS utilities directory
    - "src/hooks/useRealtimePOS.ts"
    - "src/hooks/usePOSVoid.ts"
    - "src/components/pos/"

  tasks:
    - id: POS-001
      title: "Add barcode scanner support"
      severity: high
      problem: |
        No barcode scanning for quick product lookup.
      solution: |
        1. Integrate camera-based barcode scanning
        2. Support USB barcode scanners
        3. Add product lookup by barcode
        4. Add barcode printing for products
      acceptance_criteria:
        - Camera scanning works on mobile
        - USB scanner works on desktop
        - Products found within 500ms

    - id: POS-002
      title: "Optimize POS for speed"
      severity: high
      file: "src/pages/admin/PointOfSale.tsx"
      problem: |
        POS page is 32KB and slow for high-volume operations.
      solution: |
        1. Refactor into smaller components
        2. Add keyboard shortcuts for common actions
        3. Cache frequently used products
        4. Optimize cart calculations
      acceptance_criteria:
        - Add to cart < 50ms
        - Checkout complete < 2 seconds
        - All shortcuts documented

    - id: POS-003
      title: "Add multi-payment support"
      severity: medium
      problem: |
        Can only accept one payment method per transaction.
      solution: |
        1. Allow split payments (cash + card)
        2. Add gift card as payment method
        3. Add store credit as payment method
        4. Show remaining balance during split
      acceptance_criteria:
        - Can split between 2+ methods
        - Gift card balance deducted correctly
        - Receipt shows all payment methods

    - id: POS-004
      title: "Add receipt customization"
      severity: low
      problem: |
        Receipts have limited customization options.
      solution: |
        1. Add receipt template editor
        2. Support custom logo
        3. Add custom footer text
        4. Add QR code for digital receipt
      acceptance_criteria:
        - Logo appears on receipt
        - Custom text configurable
        - QR code links to digital receipt

    - id: POS-005
      title: "Add end-of-day reporting"
      severity: medium
      file: "src/pages/admin/CashRegister.tsx"
      problem: |
        Cash register close-out process is manual.
      solution: |
        1. Add automated cash count verification
        2. Generate end-of-day summary
        3. Calculate over/short amounts
        4. Email summary to manager
      acceptance_criteria:
        - EOD wizard guides through process
        - Summary generated automatically
        - Over/short tracked per shift

# ============================================================================
# SECTION 12: WHOLESALE MODULE
# ============================================================================
wholesale:
  priority: 12
  estimated_time: "1.5 hours"
  description: |
    Complete the wholesale module for B2B operations.
  
  current_files:
    - "src/pages/admin/WholesaleClients.tsx" # 38KB
    - "src/pages/admin/WholesaleInventory.tsx" # 19KB
    - "src/pages/admin/WholesaleOrdersPage.tsx" # 35KB
    - "src/pages/admin/NewWholesaleOrder.tsx" # 50KB
    - "src/hooks/useWholesaleData.ts" # 14KB

  tasks:
    - id: WHOLESALE-001
      title: "Add tiered pricing support"
      severity: high
      problem: |
        Wholesale pricing doesn't support quantity-based tiers.
      solution: |
        1. Add pricing tier configuration per product
        2. Auto-apply best tier based on quantity
        3. Show tier breakdown on order
        4. Add minimum order quantities
      acceptance_criteria:
        - Tiers configurable per product
        - Correct tier auto-applied
        - MOQ enforced on checkout

    - id: WHOLESALE-002
      title: "Add credit terms management"
      severity: high
      problem: |
        No support for Net-30/Net-60 payment terms.
      solution: |
        1. Add payment terms per client
        2. Track outstanding balances
        3. Add payment reminders (email)
        4. Add credit limit enforcement
      acceptance_criteria:
        - Terms assignable per client
        - Balances tracked accurately
        - Credit limits enforced

    - id: WHOLESALE-003
      title: "Add wholesale catalog export"
      severity: medium
      problem: |
        No way to share wholesale catalog with clients.
      solution: |
        1. Generate PDF catalog with client-specific pricing
        2. Add online catalog page for clients
        3. Add quick order from catalog
        4. Add catalog sharing via email
      acceptance_criteria:
        - PDF catalog generates correctly
        - Client sees their pricing
        - Quick order works

# ============================================================================
# EXECUTION ORDER & DEPENDENCIES
# ============================================================================
execution_order:
  - phase: 1
    name: "Critical Auth Fixes"
    tasks: ["AUTH-001", "AUTH-002", "AUTH-003"]
    estimated_time: "2 hours"
    dependencies: []
    
  - phase: 2
    name: "Auth Enhancements"
    tasks: ["AUTH-004", "AUTH-005"]
    estimated_time: "1 hour"
    dependencies: ["phase-1"]
    
  - phase: 3
    name: "Admin Panel Flow"
    tasks: ["ADMIN-001", "ADMIN-002", "ADMIN-003"]
    estimated_time: "2 hours"
    dependencies: ["phase-2"]
    
  - phase: 4
    name: "Menu Improvements"
    tasks: ["MENU-001", "MENU-002", "MENU-003", "MENU-004", "MENU-005"]
    estimated_time: "2 hours"
    dependencies: ["phase-3"]
    
  - phase: 5
    name: "Storefront Buildout"
    tasks: ["STORE-001", "STORE-002", "STORE-003", "STORE-004", "STORE-005", "STORE-006", "STORE-007"]
    estimated_time: "4 hours"
    dependencies: ["phase-4"]
    
  - phase: 6
    name: "Code Quality"
    tasks: ["QUALITY-001", "QUALITY-002", "QUALITY-003", "QUALITY-004"]
    estimated_time: "1 hour"
    dependencies: ["phase-5"]

  - phase: 7
    name: "Testing Infrastructure"
    tasks: ["TEST-001", "TEST-002", "TEST-003", "TEST-004"]
    estimated_time: "2 hours"
    dependencies: ["phase-6"]

  - phase: 8
    name: "Performance Optimization"
    tasks: ["PERF-001", "PERF-002", "PERF-003", "PERF-004", "PERF-005"]
    estimated_time: "2 hours"
    dependencies: ["phase-6"]
    note: "Can run in parallel with phase-7"

  - phase: 9
    name: "Security Hardening"
    tasks: ["SEC-001", "SEC-002", "SEC-003", "SEC-004", "SEC-005"]
    estimated_time: "2 hours"
    dependencies: ["phase-8"]

  - phase: 10
    name: "Mobile & Offline"
    tasks: ["MOBILE-001", "MOBILE-002", "MOBILE-003", "MOBILE-004", "MOBILE-005"]
    estimated_time: "2 hours"
    dependencies: ["phase-9"]

  - phase: 11
    name: "Realtime Features"
    tasks: ["REALTIME-001", "REALTIME-002", "REALTIME-003", "REALTIME-004"]
    estimated_time: "1.5 hours"
    dependencies: ["phase-10"]

  - phase: 12
    name: "POS Enhancements"
    tasks: ["POS-001", "POS-002", "POS-003", "POS-004", "POS-005"]
    estimated_time: "2 hours"
    dependencies: ["phase-11"]

  - phase: 13
    name: "Wholesale Module"
    tasks: ["WHOLESALE-001", "WHOLESALE-002", "WHOLESALE-003"]
    estimated_time: "1.5 hours"
    dependencies: ["phase-12"]

# ============================================================================
# SUMMARY STATISTICS
# ============================================================================
summary:
  total_issues: 48
  by_severity:
    critical: 3
    high: 16
    medium: 21
    low: 8
  by_category:
    authentication: 5
    admin_panel: 3
    disposable_menus: 5
    storefront: 7
    code_quality: 4
    testing: 4
    performance: 5
    security: 5
    mobile_offline: 5
    realtime: 4
    pos: 5
    wholesale: 3
  files_to_modify:
    - "src/contexts/TenantAdminAuthContext.tsx"
    - "src/contexts/AuthContext.tsx"
    - "src/components/tenant-admin/TenantAdminSidebar.tsx"
    - "src/components/admin/Breadcrumbs.tsx"
    - "src/components/admin/disposable-menus/MenuCreationWizard.tsx"
    - "src/components/admin/disposable-menus/MobileMenuActions.tsx"
    - "src/pages/admin/storefront/StorefrontGiftCards.tsx"
    - "src/pages/admin/storefront/StorefrontBuilder.tsx"
    - "src/pages/admin/storefront/StorefrontLiveOrders.tsx"
    - "src/pages/admin/storefront/StorefrontSettings.tsx"
    - "src/pages/admin/storefront/StorefrontAnalytics.tsx"
    - "src/pages/admin/AdminLayout.tsx"
    - "src/lib/performance.ts"
    - "src/lib/rateLimit.ts"
    - "src/lib/offlineQueue.ts"
    - "src/lib/realtime.ts"
    - "src/pages/admin/PointOfSale.tsx"
    - "src/pages/admin/CashRegister.tsx"
    - "src/hooks/useWholesaleData.ts"
  new_files_to_create:
    - "src/hooks/useSectionManager.ts"
    - "src/hooks/useThemeManager.ts"
    - "src/hooks/useStoreManager.ts"
    - "src/components/storefront/BuilderSidebar.tsx"
    - "src/components/storefront/BuilderPreview.tsx"
    - "src/components/storefront/SectionEditor.tsx"
    - "src/components/storefront/GiftCardForm.tsx"
    - "src/components/storefront/GiftCardTable.tsx"
    - "src/test/e2e/auth.test.ts"
    - "src/test/e2e/checkout.test.ts"
    - "src/test/e2e/orders.test.ts"
    - "src/lib/security/csp.ts"
    - "src/components/pos/BarcodeScanner.tsx"
    - "src/components/pos/SplitPayment.tsx"
    - "src/components/wholesale/PricingTiers.tsx"
  estimated_total_time: "22-26 hours"
  overnight_priority: |
    For a single overnight session, prioritize:
    1. AUTH-001, AUTH-002, AUTH-003 (Critical)
    2. SEC-001 (Critical security)
    3. STORE-001, STORE-002 (High impact)
    4. PERF-001, PERF-004 (High impact)
    5. MOBILE-001, MOBILE-003 (User-facing)

