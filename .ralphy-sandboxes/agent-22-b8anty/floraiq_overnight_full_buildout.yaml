name: FloraIQ Overnight Full Buildout - Auth, Panels, Menus, Storefront
description: >
  Complete overnight sprint to fix critical issues and build out features:


  1. AUTH SYSTEM - Fix all build errors blocking login, fix logout flow, token
  refresh

  2. ADMIN PANELS - Verify all panels interconnected and working

  3. DISPOSABLE MENUS - Complete feature buildout with security hardening

  4. STOREFRONT - Full public marketplace implementation


  RUN WITH: ralphy --yaml floraiq_overnight_full_buildout.yaml --parallel
  --max-parallel 5 --fast
version: 3.0.0
estimated_hours: 10
rules:
  - Fix ALL TypeScript errors - build must succeed
  - Use TypeScript strict mode with explicit types
  - Always include tenant_id isolation in database queries
  - Use TanStack Query with proper cache invalidation
  - Test each fix by running npm run build
  - Add proper error handling with toast notifications
  - Ensure mobile responsiveness
  - Follow existing component patterns
tasks:
  - id: fix-tenant-admin-auth-context
    title: Fix TenantAdminAuthContext - Add Missing tenantSlug Property
    priority: P0
    estimated_minutes: 15
    description: >
      The build is failing because tenantSlug is missing from
      TenantAdminAuthContext.


      File: src/contexts/TenantAdminAuthContext.tsx


      ## Changes Required:


      1. Add tenantSlug to interface (around line 79):

      ```typescript

      interface TenantAdminAuthContextType {
        admin: TenantAdmin | null;
        tenant: Tenant | null;
        tenantSlug: string | null; // ADD THIS
        token: string | null;
        accessToken: string | null;
        refreshToken: string | null;
        isAuthenticated: boolean;
        connectionStatus: ConnectionStatus;
        loading: boolean;
        login: (email: string, password: string, tenantSlug: string) => Promise<void>;
        logout: () => Promise<void>;
        refreshAuthToken: () => Promise<boolean>;
        refreshTenant: () => Promise<void>;
        handleSignupSuccess?: (signupResult: SignupResult) => Promise<void>;
        mfaRequired: boolean;
        verifyMfa: (code: string) => Promise<void>;
      }

      ```


      2. Add state in provider:

      ```typescript

      const [tenantSlug, setTenantSlug] = useState<string | null>(null);

      ```


      3. Add effect to sync tenantSlug:

      ```typescript

      useEffect(() => {
        setTenantSlug(tenant?.slug ?? null);
      }, [tenant]);

      ```


      4. Include in provider value:

      ```typescript

      value={{
        // ...existing
        tenantSlug,
      }}

      ```


      Run `npm run build` to verify this error is fixed.
    acceptance_criteria:
      - tenantSlug property exists in context
      - No TypeScript errors related to tenantSlug
      - Build passes this check
    completed: true
  - id: fix-missing-exports-and-modules
    title: Fix Missing Default Exports and Create Sanitize Module
    priority: P0
    estimated_minutes: 15
    description: >
      Multiple files missing exports causing build failure.


      ## 1. Add default export to InvoicesPage

      File: src/pages/admin/InvoicesPage.tsx

      Add at end of file:

      ```typescript

      export default InvoicesPage;

      ```


      ## 2. Create missing sanitize module

      Create NEW file: src/lib/utils/sanitize.ts

      ```typescript

      import DOMPurify from 'dompurify';


      /**
       * Sanitize HTML content to prevent XSS attacks
       */
      export function sanitizeHtml(html: string): string {
        return DOMPurify.sanitize(html, {
          ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'a', 'ul', 'ol', 'li', 
                         'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'span', 'div', 'img'],
          ALLOWED_ATTR: ['href', 'target', 'rel', 'src', 'alt', 'class', 'style'],
          ALLOW_DATA_ATTR: false,
        });
      }


      /**
       * Strip all HTML tags, returning plain text
       */
      export function stripHtml(html: string): string {
        return DOMPurify.sanitize(html, { ALLOWED_TAGS: [] });
      }


      /**
       * Sanitize user input for database storage
       */
      export function sanitizeInput(input: string): string {
        return input.trim().replace(/[<>]/g, '');
      }

      ```


      ## 3. Add FreeAction type

      File: src/lib/credits/creditCosts.ts

      Add before the isActionFree function:

      ```typescript

      /** Type for free actions that don't consume credits */

      export type FreeAction = typeof FREE_ACTIONS[number];

      ```


      Run `npm run build` to verify.
    acceptance_criteria:
      - InvoicesPage has default export
      - sanitize.ts module exists and exports functions
      - FreeAction type is exported
      - Build passes these checks
    completed: true
  - id: fix-type-mismatches-cash-register
    title: Fix CashRegister Type Mismatches
    priority: P0
    estimated_minutes: 20
    description: |
      File: src/pages/admin/CashRegister.tsx

      ## Fix 1: Customer query (around line 208)
      Change:
      ```typescript
      .select('id, name, email, phone')
      ```
      To:
      ```typescript
      .select('id, first_name, last_name, email, phone')
      ```

      ## Fix 2: tenant.name usage (around line 537)
      Change:
      ```typescript
      tenant.name
      ```
      To:
      ```typescript
      tenant.business_name
      ```

      ## Fix 3: Remove unused @ts-expect-error directives
      Remove directives at lines 224 and 353 if the underlying issues are fixed.

      ## Fix 4: Customer display
      Update any customer name display to use:
      ```typescript
      `${customer.first_name} ${customer.last_name}`
      ```

      Run `npm run build` to verify.
    acceptance_criteria:
      - Customer query uses correct column names
      - tenant.business_name used instead of tenant.name
      - No unused ts-expect-error directives
      - Build passes
    completed: true
  - id: fix-type-mismatches-remaining
    title: Fix Remaining Type Mismatches Across Codebase
    priority: P0
    estimated_minutes: 25
    description: |
      ## 1. useInvoices.ts
      File: src/hooks/crm/useInvoices.ts

      Line 18 - Add type assertion:
      ```typescript
      const data = result.data as unknown as CRMInvoice[];
      ```

      ## 2. VendorManagement.tsx
      File: src/pages/admin/VendorManagement.tsx

      Line 84 - Add type assertion:
      ```typescript
      const data = vendorData as unknown as Vendor[];
      ```

      Line 137 - Fix insert:
      ```typescript
      .insert(formData as any)
      ```

      ## 3. CustomerManagement.tsx
      File: src/pages/admin/CustomerManagement.tsx

      Fix decryption to return full objects:
      ```typescript
      return customers.map(c => ({
        ...c,
        first_name: decryptField(c.first_name),
        last_name: decryptField(c.last_name),
        email: decryptField(c.email),
        phone: decryptField(c.phone),
      }));
      ```

      ## 4. InventoryManagement.tsx
      File: src/pages/admin/InventoryManagement.tsx

      Lines 168 & 202 - Fix Badge variant:
      ```typescript
      // Change: variant="warning"
      // To: variant="secondary"
      ```

      ## 5. StorefrontBuilder.tsx
      File: src/pages/admin/storefront/StorefrontBuilder.tsx

      Remove unused @ts-expect-error at lines 274, 352, 390, 455

      Run `npm run build` - should have ZERO errors now.
    acceptance_criteria:
      - All type mismatches fixed
      - No unused ts-expect-error directives
      - npm run build succeeds with 0 errors
    completed: true
  - id: fix-login-flow-complete
    title: Fix Complete Login Flow - Token Storage and Validation
    priority: P0
    estimated_minutes: 35
    description: >
      Complete overhaul of login flow to fix authentication issues.


      ## File: src/pages/saas/LoginPage.tsx


      ### 1. Clear ALL stale tokens before login attempt:

      ```typescript

      const clearAllTokens = () => {
        // Clear localStorage
        localStorage.removeItem('sb-access-token');
        localStorage.removeItem('sb-refresh-token');
        localStorage.removeItem('tenant_admin_token');
        localStorage.removeItem('tenant_admin_refresh_token');
        localStorage.removeItem('tenant_admin');
        localStorage.removeItem('tenant_data');
        
        // Clear sessionStorage
        sessionStorage.clear();
        
        // Clear cookies
        document.cookie.split(";").forEach(c => {
          document.cookie = c.replace(/^ +/, "")
            .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
      };

      ```


      ### 2. Call clearAllTokens before login:

      ```typescript

      const handleLogin = async (email: string, password: string) => {
        clearAllTokens();
        setLoading(true);
        setError(null);
        
        try {
          await login(email, password, tenantSlug);
          navigate(`/${tenantSlug}/admin/dashboard`);
        } catch (err) {
          setError(err instanceof Error ? err.message : 'Login failed');
        } finally {
          setLoading(false);
        }
      };

      ```


      ## File: src/contexts/TenantAdminAuthContext.tsx


      ### 3. Fix token storage after successful login:

      ```typescript

      const login = async (email: string, password: string, slug: string) => {
        const response = await supabase.functions.invoke('tenant-admin-auth', {
          body: { action: 'login', email, password, tenantSlug: slug }
        });
        
        if (response.error) throw response.error;
        
        const { admin, tenant, accessToken, refreshToken } = response.data;
        
        // Store tokens
        localStorage.setItem('tenant_admin_token', accessToken);
        localStorage.setItem('tenant_admin_refresh_token', refreshToken);
        localStorage.setItem('tenant_admin', JSON.stringify(admin));
        localStorage.setItem('tenant_data', JSON.stringify(tenant));
        
        // Update state
        setAdmin(admin);
        setTenant(tenant);
        setTenantSlug(slug);
        setAccessToken(accessToken);
        setRefreshToken(refreshToken);
        setIsAuthenticated(true);
      };

      ```


      ### 4. Add token refresh on 401:

      ```typescript

      // In any API call wrapper

      const apiCall = async (fn: () => Promise<any>) => {
        try {
          return await fn();
        } catch (error: any) {
          if (error?.status === 401) {
            const refreshed = await refreshAuthToken();
            if (refreshed) {
              return await fn(); // Retry
            } else {
              await logout();
              throw new Error('Session expired');
            }
          }
          throw error;
        }
      };

      ```
    acceptance_criteria:
      - Login clears all stale tokens first
      - Tokens stored correctly after login
      - 401 errors trigger token refresh
      - Failed refresh triggers logout
    completed: true
  - id: fix-logout-flow-complete
    title: Fix Complete Logout Flow - Clean All State
    priority: P0
    estimated_minutes: 25
    description: >
      ## File: src/contexts/TenantAdminAuthContext.tsx


      ### Complete logout function:

      ```typescript

      const logout = async () => {
        try {
          // Call server to revoke tokens
          await supabase.functions.invoke('tenant-admin-auth', {
            body: { 
              action: 'logout',
              refreshToken: refreshToken 
            }
          });
        } catch (e) {
          console.error('Server logout failed:', e);
        } finally {
          // Always clear local state regardless of server response
          
          // Clear all localStorage
          localStorage.removeItem('tenant_admin_token');
          localStorage.removeItem('tenant_admin_refresh_token');
          localStorage.removeItem('tenant_admin');
          localStorage.removeItem('tenant_data');
          localStorage.removeItem('sb-access-token');
          localStorage.removeItem('sb-refresh-token');
          
          // Clear sessionStorage
          sessionStorage.clear();
          
          // Clear cookies
          document.cookie.split(";").forEach(c => {
            document.cookie = c.replace(/^ +/, "")
              .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
          });
          
          // Clear React Query cache
          queryClient.clear();
          
          // Reset all state
          setAdmin(null);
          setTenant(null);
          setTenantSlug(null);
          setAccessToken(null);
          setRefreshToken(null);
          setIsAuthenticated(false);
          
          // Navigate to login
          navigate(`/${tenantSlug}/admin/login`);
        }
      };

      ```


      ### Add logout button to all admin pages header:

      ```typescript

      // In AdminLayout or similar

      <Button variant="ghost" onClick={logout}>
        <LogOut className="h-4 w-4 mr-2" />
        Logout
      </Button>

      ```
    acceptance_criteria:
      - Logout clears ALL storage
      - Server notified of logout
      - Query cache cleared
      - Redirects to login page
    completed: true
  - id: fix-token-refresh-mechanism
    title: Fix Token Refresh Mechanism - Auto Refresh Before Expiry
    priority: P0
    estimated_minutes: 30
    description: >
      ## File: src/contexts/TenantAdminAuthContext.tsx


      ### 1. Add token expiry tracking:

      ```typescript

      const [tokenExpiry, setTokenExpiry] = useState<number | null>(null);


      // Parse JWT to get expiry

      const getTokenExpiry = (token: string): number => {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.exp * 1000; // Convert to milliseconds
        } catch {
          return Date.now() + 3600000; // Default 1 hour
        }
      };

      ```


      ### 2. Auto-refresh 5 minutes before expiry:

      ```typescript

      useEffect(() => {
        if (!accessToken || !tokenExpiry) return;
        
        const refreshBuffer = 5 * 60 * 1000; // 5 minutes
        const timeUntilRefresh = tokenExpiry - Date.now() - refreshBuffer;
        
        if (timeUntilRefresh <= 0) {
          // Token expired or about to expire
          refreshAuthToken();
          return;
        }
        
        const timer = setTimeout(() => {
          refreshAuthToken();
        }, timeUntilRefresh);
        
        return () => clearTimeout(timer);
      }, [accessToken, tokenExpiry]);

      ```


      ### 3. Refresh function:

      ```typescript

      const refreshAuthToken = async (): Promise<boolean> => {
        if (!refreshToken) return false;
        
        try {
          const response = await supabase.functions.invoke('tenant-admin-auth', {
            body: { 
              action: 'refresh',
              refreshToken 
            }
          });
          
          if (response.error) throw response.error;
          
          const { accessToken: newAccess, refreshToken: newRefresh } = response.data;
          
          // Update storage
          localStorage.setItem('tenant_admin_token', newAccess);
          localStorage.setItem('tenant_admin_refresh_token', newRefresh);
          
          // Update state
          setAccessToken(newAccess);
          setRefreshToken(newRefresh);
          setTokenExpiry(getTokenExpiry(newAccess));
          
          return true;
        } catch (error) {
          console.error('Token refresh failed:', error);
          return false;
        }
      };

      ```


      ## File: supabase/functions/tenant-admin-auth/index.ts


      ### 4. Add refresh action handler:

      ```typescript

      if (action === 'refresh') {
        const { refreshToken } = body;
        
        // Verify refresh token
        const { data: tokenData, error } = await supabaseAdmin
          .from('tenant_admin_refresh_tokens')
          .select('*, tenant_admins(*)')
          .eq('token', refreshToken)
          .eq('revoked', false)
          .gt('expires_at', new Date().toISOString())
          .single();
        
        if (error || !tokenData) {
          return new Response(JSON.stringify({ error: 'Invalid refresh token' }), {
            status: 401,
            headers: corsHeaders
          });
        }
        
        // Generate new tokens
        const newAccessToken = generateAccessToken(tokenData.tenant_admins);
        const newRefreshToken = generateRefreshToken();
        
        // Rotate refresh token (revoke old, create new)
        await supabaseAdmin
          .from('tenant_admin_refresh_tokens')
          .update({ revoked: true })
          .eq('id', tokenData.id);
        
        await supabaseAdmin
          .from('tenant_admin_refresh_tokens')
          .insert({
            admin_id: tokenData.admin_id,
            token: newRefreshToken,
            expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
          });
        
        return new Response(JSON.stringify({
          accessToken: newAccessToken,
          refreshToken: newRefreshToken
        }), {
          headers: corsHeaders
        });
      }

      ```
    acceptance_criteria:
      - Token expiry tracked
      - Auto-refresh 5 min before expiry
      - Refresh token rotation works
      - Edge function handles refresh action
    completed: true
  - id: fix-auth-edge-function-deployment
    title: Deploy and Verify Auth Edge Functions
    priority: P0
    estimated_minutes: 15
    description: >
      Deploy all auth-related edge functions to external Supabase project.


      Project ref: mtvwmyerntkhrcdnhahp


      ## Commands:

      ```bash

      cd supabase

      supabase link --project-ref mtvwmyerntkhrcdnhahp


      # Deploy auth functions

      supabase functions deploy tenant-admin-auth

      supabase functions deploy super-admin-auth

      supabase functions deploy customer-auth

      supabase functions deploy revoke-all-sessions

      ```


      ## Verify secrets are set:

      ```bash

      supabase secrets list

      ```


      Required secrets:

      - JWT_SECRET

      - SUPABASE_SERVICE_ROLE_KEY


      ## Test login endpoint:

      ```bash

      curl -X POST
      https://mtvwmyerntkhrcdnhahp.supabase.co/functions/v1/tenant-admin-auth \
        -H "Content-Type: application/json" \
        -d '{"action": "health"}'
      ```
    acceptance_criteria:
      - All auth functions deployed
      - Secrets configured
      - Health check passes
    completed: true
  - id: verify-admin-panel-navigation
    title: Verify All Admin Panels Navigation and Data Flow
    priority: P1
    estimated_minutes: 30
    description: |
      Verify all admin panels are properly interconnected.

      ## Check each panel loads and links work:

      1. Dashboard (/admin/dashboard)
         - [ ] Links to all other panels
         - [ ] Shows summary stats from other panels
         - [ ] Quick actions work

      2. Products (/admin/products)
         - [ ] CRUD operations work
         - [ ] Links to inventory
         - [ ] Links to orders containing product

      3. Orders (/admin/orders)
         - [ ] List loads with tenant_id filter
         - [ ] Links to customer details
         - [ ] Links to product details
         - [ ] Status updates work

      4. Customers (/admin/customers)
         - [ ] List loads with decryption
         - [ ] Links to customer orders
         - [ ] Links to customer invoices

      5. Inventory (/admin/inventory)
         - [ ] Stock levels display
         - [ ] Links to products
         - [ ] Low stock alerts work

      6. Invoices (/admin/invoices)
         - [ ] List loads
         - [ ] Links to customer
         - [ ] Links to order
         - [ ] PDF generation works

      7. Cash Register (/admin/pos)
         - [ ] Products load
         - [ ] Customer search works
         - [ ] Transaction completes
         - [ ] Receipt prints

      8. Vendors (/admin/vendors)
         - [ ] CRUD operations
         - [ ] Links to products from vendor

      ## Fix any broken links by ensuring:
      - All routes defined in router
      - All Link components use correct paths
      - All data fetches include tenant_id
    acceptance_criteria:
      - All panels load without errors
      - Navigation between panels works
      - Data relationships maintained
    completed: true
  - id: add-admin-sidebar-navigation
    title: Add Consistent Sidebar Navigation to All Admin Pages
    priority: P1
    estimated_minutes: 25
    description: >
      Ensure all admin pages use AdminLayout with consistent sidebar.


      ## File: src/components/admin/AdminLayout.tsx


      ```typescript

      import { Link, useLocation } from 'react-router-dom';

      import { useTenantAdminAuth } from '@/contexts/TenantAdminAuthContext';

      import {
        LayoutDashboard, Package, ShoppingCart, Users, Warehouse,
        FileText, DollarSign, Store, Menu, Settings, LogOut
      } from 'lucide-react';


      const navItems = [
        { path: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
        { path: 'products', label: 'Products', icon: Package },
        { path: 'orders', label: 'Orders', icon: ShoppingCart },
        { path: 'customers', label: 'Customers', icon: Users },
        { path: 'inventory', label: 'Inventory', icon: Warehouse },
        { path: 'invoices', label: 'Invoices', icon: FileText },
        { path: 'pos', label: 'Cash Register', icon: DollarSign },
        { path: 'vendors', label: 'Vendors', icon: Store },
        { path: 'disposable-menus', label: 'Menus', icon: Menu },
        { path: 'storefront', label: 'Storefront', icon: Store },
        { path: 'settings', label: 'Settings', icon: Settings },
      ];


      export const AdminLayout = ({ children }: { children: React.ReactNode })
      => {
        const { tenantSlug, tenant, logout } = useTenantAdminAuth();
        const location = useLocation();
        
        return (
          <div className="flex h-screen">
            {/* Sidebar */}
            <aside className="w-64 bg-card border-r flex flex-col">
              <div className="p-4 border-b">
                <h1 className="font-bold text-lg">{tenant?.business_name}</h1>
              </div>
              
              <nav className="flex-1 p-2 space-y-1">
                {navItems.map(item => {
                  const Icon = item.icon;
                  const path = `/${tenantSlug}/admin/${item.path}`;
                  const isActive = location.pathname === path;
                  
                  return (
                    <Link
                      key={item.path}
                      to={path}
                      className={cn(
                        "flex items-center gap-3 px-3 py-2 rounded-md transition-colors",
                        isActive 
                          ? "bg-primary text-primary-foreground" 
                          : "hover:bg-muted"
                      )}
                    >
                      <Icon className="h-4 w-4" />
                      {item.label}
                    </Link>
                  );
                })}
              </nav>
              
              <div className="p-2 border-t">
                <Button variant="ghost" className="w-full justify-start" onClick={logout}>
                  <LogOut className="h-4 w-4 mr-2" />
                  Logout
                </Button>
              </div>
            </aside>
            
            {/* Main content */}
            <main className="flex-1 overflow-auto">
              {children}
            </main>
          </div>
        );
      };

      ```


      ## Wrap all admin pages with AdminLayout in router
    acceptance_criteria:
      - Sidebar shows on all admin pages
      - Active state highlights current page
      - Logout button works
      - Mobile responsive
    completed: true
  - id: add-breadcrumb-navigation
    title: Add Breadcrumb Navigation Between Panels
    priority: P2
    estimated_minutes: 20
    description: >
      Add breadcrumb navigation for better UX.


      ## File: src/components/admin/Breadcrumbs.tsx


      ```typescript

      import { Link, useLocation } from 'react-router-dom';

      import { ChevronRight, Home } from 'lucide-react';

      import { useTenantAdminAuth } from '@/contexts/TenantAdminAuthContext';


      export const Breadcrumbs = () => {
        const { tenantSlug } = useTenantAdminAuth();
        const location = useLocation();
        
        const pathSegments = location.pathname
          .split('/')
          .filter(Boolean)
          .slice(2); // Remove tenantSlug and 'admin'
        
        const breadcrumbs = pathSegments.map((segment, index) => {
          const path = `/${tenantSlug}/admin/${pathSegments.slice(0, index + 1).join('/')}`;
          const label = segment.charAt(0).toUpperCase() + segment.slice(1).replace(/-/g, ' ');
          
          return { path, label };
        });
        
        return (
          <nav className="flex items-center gap-2 text-sm text-muted-foreground mb-4">
            <Link to={`/${tenantSlug}/admin/dashboard`} className="hover:text-foreground">
              <Home className="h-4 w-4" />
            </Link>
            
            {breadcrumbs.map((crumb, index) => (
              <Fragment key={crumb.path}>
                <ChevronRight className="h-4 w-4" />
                {index === breadcrumbs.length - 1 ? (
                  <span className="text-foreground font-medium">{crumb.label}</span>
                ) : (
                  <Link to={crumb.path} className="hover:text-foreground">
                    {crumb.label}
                  </Link>
                )}
              </Fragment>
            ))}
          </nav>
        );
      };

      ```


      Add to all admin pages.
    acceptance_criteria:
      - Breadcrumbs show on all admin pages
      - Links navigate correctly
      - Current page highlighted
    completed: true
  - id: enhance-menu-generation
    title: Enhance Disposable Menu Generation with Advanced Options
    priority: P1
    estimated_minutes: 40
    description: |
      ## File: src/components/admin/disposable-menus/CreateMenuDialog.tsx

      Add advanced menu creation options:

      ```typescript
      interface MenuOptions {
        // Basic
        name: string;
        products: string[]; // Product IDs
        
        // Pricing
        customPrices: Record<string, number>; // productId -> price
        applyDiscount: boolean;
        discountPercent: number;
        
        // Expiration
        expirationHours: number; // 1-168
        maxViews: number; // 1-1000
        
        // Security
        accessCodeEnabled: boolean;
        accessCode: string; // 4-8 digits
        geofencingEnabled: boolean;
        geofence: {
          lat: number;
          lng: number;
          radiusMiles: number;
        };
        
        // Whitelist
        whitelistEnabled: boolean;
        whitelistedEmails: string[];
        whitelistedPhones: string[];
        
        // Branding
        showBranding: boolean;
        customMessage: string;
        headerImage: string;
      }
      ```

      ## Add form sections:
      1. Product Selection - Multi-select with search
      2. Custom Pricing - Override prices per product
      3. Expiration Settings - Hours and max views
      4. Security Options - Access code, geofencing
      5. Whitelist - Specific emails/phones only
      6. Branding - Custom header and message

      ## Add QR code generation:
      ```typescript
      import QRCode from 'qrcode';

      const generateQRCode = async (url: string) => {
        const qrDataUrl = await QRCode.toDataURL(url, {
          width: 256,
          margin: 2,
          color: { dark: '#000', light: '#fff' }
        });
        return qrDataUrl;
      };
      ```
    acceptance_criteria:
      - All menu options configurable
      - Custom pricing works
      - QR code generates
      - Form validates all inputs
    completed: true
  - id: enhance-menu-security
    title: Enhance Menu Security - Screenshot Detection and Velocity Checks
    priority: P1
    estimated_minutes: 35
    description: >
      ## File: src/lib/security/auto-burn.ts


      ```typescript

      // Screenshot detection

      export const initScreenshotDetection = (menuId: string, onDetect: () =>
      void) => {
        // Visibility change (switching apps to screenshot)
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            // Potential screenshot - log but don't burn immediately
            logSuspiciousActivity(menuId, 'visibility_hidden');
          }
        });
        
        // Print screen key
        document.addEventListener('keyup', (e) => {
          if (e.key === 'PrintScreen') {
            onDetect();
            burnMenu(menuId, 'screenshot_detected');
          }
        });
        
        // DevTools detection
        let devToolsOpen = false;
        const threshold = 160;
        
        setInterval(() => {
          const widthThreshold = window.outerWidth - window.innerWidth > threshold;
          const heightThreshold = window.outerHeight - window.innerHeight > threshold;
          
          if (widthThreshold || heightThreshold) {
            if (!devToolsOpen) {
              devToolsOpen = true;
              logSuspiciousActivity(menuId, 'devtools_opened');
            }
          } else {
            devToolsOpen = false;
          }
        }, 1000);
      };


      // Velocity check - too many requests

      export const checkVelocity = async (menuId: string, ip: string):
      Promise<boolean> => {
        const key = `menu_velocity:${menuId}:${ip}`;
        const now = Date.now();
        const windowMs = 60000; // 1 minute
        const maxRequests = 10;
        
        // Get recent requests from Redis or in-memory
        const requests = await getRecentRequests(key, windowMs);
        
        if (requests.length >= maxRequests) {
          await burnMenu(menuId, 'velocity_exceeded');
          return false; // Block
        }
        
        await addRequest(key, now);
        return true; // Allow
      };

      ```


      ## File: supabase/functions/menu-access-validate/index.ts


      Add velocity check before allowing access:

      ```typescript

      // Get client IP

      const clientIp = req.headers.get('x-forwarded-for') || 'unknown';

      const ipHash = await hashIp(clientIp);


      // Check velocity

      const velocityOk = await checkVelocity(menuId, ipHash);

      if (!velocityOk) {
        return new Response(JSON.stringify({ error: 'Too many requests' }), {
          status: 429
        });
      }

      ```
    acceptance_criteria:
      - Screenshot detection triggers burn
      - DevTools detection logs activity
      - Velocity check blocks rapid access
      - All suspicious activity logged
    completed: true
  - id: enhance-menu-analytics
    title: Enhance Disposable Menu Analytics Dashboard
    priority: P1
    estimated_minutes: 30
    description: |
      ## File: src/components/admin/disposable-menus/SmartDashboard.tsx

      Add comprehensive analytics:

      ```typescript
      // Stats to show
      interface MenuAnalytics {
        totalMenus: number;
        activeMenus: number;
        burnedMenus: number;
        totalViews: number;
        totalOrders: number;
        conversionRate: number; // orders / views
        avgViewsPerMenu: number;
        avgTimeToFirstView: number; // minutes
        burnReasons: Record<string, number>;
        viewsByHour: { hour: number; views: number }[];
        topProducts: { id: string; name: string; orders: number }[];
      }
      ```

      ## Add charts:
      1. Views over time (line chart)
      2. Burn reasons (pie chart)
      3. Active vs burned (donut chart)
      4. Conversion funnel (funnel chart)
      5. Geographic heatmap (if geolocation data)

      ## Add real-time viewer count:
      ```typescript
      // Subscribe to menu_access_logs
      useEffect(() => {
        const channel = supabase
          .channel('menu-analytics')
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'menu_access_logs',
            filter: `tenant_id=eq.${tenantId}`
          }, (payload) => {
            // Update real-time stats
            setRealtimeViews(prev => prev + 1);
          })
          .subscribe();
        
        return () => supabase.removeChannel(channel);
      }, [tenantId]);
      ```
    acceptance_criteria:
      - All stats display correctly
      - Charts render with real data
      - Real-time updates work
      - Export to CSV option
    completed: true
  - id: enhance-menu-ordering
    title: Enhance Menu Customer Ordering Experience
    priority: P1
    estimated_minutes: 35
    description: >
      ## File: src/pages/customer/SecureMenuAccess.tsx


      Improve the customer ordering experience:


      1. Beautiful product cards:

      ```typescript

      <Card className="overflow-hidden group">
        <div className="relative aspect-square">
          <img src={product.image} className="object-cover" />
          {product.strain_type && (
            <Badge className={cn(
              "absolute top-2 right-2",
              product.strain_type === 'indica' && "bg-purple-500",
              product.strain_type === 'sativa' && "bg-orange-500",
              product.strain_type === 'hybrid' && "bg-green-500"
            )}>
              {product.strain_type}
            </Badge>
          )}
        </div>
        <CardContent className="p-4">
          <h3 className="font-bold">{product.name}</h3>
          <p className="text-sm text-muted-foreground">{product.thc}% THC</p>
          <p className="text-lg font-bold">${product.price}</p>
          <Button onClick={() => addToCart(product)} className="w-full mt-2">
            Add to Cart
          </Button>
        </CardContent>
      </Card>

      ```


      2. Sticky cart summary:

      ```typescript

      <div className="fixed bottom-0 left-0 right-0 bg-card border-t p-4
      shadow-lg">
        <div className="container flex justify-between items-center">
          <div>
            <p className="font-bold">{itemCount} items</p>
            <p className="text-2xl font-bold">${subtotal.toFixed(2)}</p>
          </div>
          <Button size="lg" onClick={() => setShowCart(true)}>
            View Cart
          </Button>
        </div>
      </div>

      ```


      3. Expiration countdown:

      ```typescript

      const TimeRemaining = ({ expiresAt }: { expiresAt: Date }) => {
        const [remaining, setRemaining] = useState('');
        
        useEffect(() => {
          const interval = setInterval(() => {
            const diff = expiresAt.getTime() - Date.now();
            if (diff <= 0) {
              setRemaining('Expired');
              return;
            }
            const hours = Math.floor(diff / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            setRemaining(`${hours}h ${mins}m remaining`);
          }, 1000);
          
          return () => clearInterval(interval);
        }, [expiresAt]);
        
        return <Badge variant="outline">{remaining}</Badge>;
      };

      ```


      4. Order confirmation with SMS option
    acceptance_criteria:
      - Product cards look great
      - Cart summary sticky at bottom
      - Expiration countdown works
      - Order completes successfully
    completed: true
  - id: complete-storefront-builder
    title: Complete Storefront Builder with All Section Types
    priority: P1
    estimated_minutes: 50
    description: |
      ## File: src/pages/admin/storefront/StorefrontBuilder.tsx

      Ensure all 8 section types are fully implemented:

      ### 1. Hero Section
      - Full-width background image/video
      - Headline, subheadline, CTA button
      - Overlay color and opacity

      ### 2. Product Grid
      - Configurable columns (2-4)
      - Featured products selection
      - Category filter
      - "Add to cart" buttons

      ### 3. Features Section
      - Icon + title + description cards
      - Configurable columns
      - Link to pages

      ### 4. Testimonials
      - Customer quotes with photos
      - Star ratings
      - Carousel or grid layout

      ### 5. Newsletter
      - Email capture form
      - Mailchimp/Resend integration
      - Success message

      ### 6. Gallery
      - Image grid
      - Lightbox on click
      - Captions

      ### 7. FAQ
      - Accordion layout
      - Question + answer pairs
      - Schema markup for SEO

      ### 8. Custom HTML
      - Raw HTML/CSS input
      - Sanitized before render
      - Preview pane

      ## Each section needs:
      - Edit dialog with all options
      - Live preview
      - Responsive settings (mobile/desktop)
      - Delete with confirmation
    acceptance_criteria:
      - All 8 section types work
      - Edit dialogs fully functional
      - Preview updates in real-time
      - Sections save to database
    completed: true
  - id: complete-storefront-checkout
    title: Complete Storefront Checkout with Stripe
    priority: P1
    estimated_minutes: 45
    description: >
      ## File: src/pages/shop/CheckoutPage.tsx


      Complete checkout implementation:


      ### 1. Customer Info Form

      ```typescript

      const customerSchema = z.object({
        firstName: z.string().min(1, 'Required'),
        lastName: z.string().min(1, 'Required'),
        email: z.string().email('Invalid email'),
        phone: z.string().min(10, 'Invalid phone'),
        dateOfBirth: z.date().refine(
          dob => {
            const age = differenceInYears(new Date(), dob);
            return age >= 21;
          },
          'Must be 21 or older'
        ),
      });

      ```


      ### 2. Delivery/Pickup Selection

      ```typescript

      <RadioGroup value={fulfillment} onValueChange={setFulfillment}>
        <div className="flex items-center space-x-2">
          <RadioGroupItem value="pickup" id="pickup" />
          <Label htmlFor="pickup">Pickup (Free)</Label>
        </div>
        <div className="flex items-center space-x-2">
          <RadioGroupItem value="delivery" id="delivery" />
          <Label htmlFor="delivery">Delivery ($5.00)</Label>
        </div>
      </RadioGroup>

      ```


      ### 3. Delivery Address (if delivery)

      ```typescript

      const addressSchema = z.object({
        street: z.string().min(1),
        apt: z.string().optional(),
        city: z.string().min(1),
        state: z.string().length(2),
        zip: z.string().regex(/^\d{5}$/),
      });

      ```


      ### 4. Stripe Elements

      ```typescript

      import { Elements, PaymentElement, useStripe, useElements } from
      '@stripe/react-stripe-js';


      const CheckoutForm = () => {
        const stripe = useStripe();
        const elements = useElements();
        
        const handleSubmit = async (e: React.FormEvent) => {
          e.preventDefault();
          
          const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: {
              return_url: `${window.location.origin}/shop/${storeSlug}/order/success`,
            },
          });
          
          if (error) {
            setError(error.message);
          }
        };
        
        return (
          <form onSubmit={handleSubmit}>
            <PaymentElement />
            <Button type="submit" disabled={!stripe}>
              Pay ${total.toFixed(2)}
            </Button>
          </form>
        );
      };

      ```


      ### 5. Order Summary

      - Item list with quantities

      - Subtotal, tax, delivery fee, total

      - Promo code input


      ## File: supabase/functions/storefront-checkout/index.ts


      Create order and Stripe PaymentIntent:

      ```typescript

      // Create order in database

      const { data: order } = await supabaseAdmin
        .from('storefront_orders')
        .insert({
          store_id: storeId,
          tenant_id: tenantId,
          customer_info: customerInfo,
          items: cartItems,
          subtotal,
          tax_amount: taxAmount,
          delivery_fee: deliveryFee,
          total_amount: total,
          status: 'pending',
          fulfillment_type: fulfillment,
          delivery_address: deliveryAddress,
        })
        .select()
        .single();

      // Create Stripe PaymentIntent

      const paymentIntent = await stripe.paymentIntents.create({
        amount: Math.round(total * 100),
        currency: 'usd',
        metadata: {
          order_id: order.id,
          store_id: storeId,
        },
      });


      return { clientSecret: paymentIntent.client_secret, orderId: order.id };

      ```
    acceptance_criteria:
      - Customer form validates (21+ age check)
      - Delivery/pickup selection works
      - Stripe Elements load
      - Payment processes
      - Order created in database
    completed: true
  - id: complete-storefront-order-management
    title: Complete Storefront Order Management
    priority: P1
    estimated_minutes: 35
    description: >
      ## File: src/pages/admin/storefront/StorefrontLiveOrders.tsx


      Complete order management:


      ### 1. Real-time order feed

      ```typescript

      useEffect(() => {
        const channel = supabase
          .channel('storefront-orders')
          .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'storefront_orders',
            filter: `tenant_id=eq.${tenantId}`
          }, (payload) => {
            if (payload.eventType === 'INSERT') {
              // Play sound
              new Audio('/sounds/new-order.mp3').play();
              // Show toast
              toast.success(`New order #${payload.new.order_number}!`);
              // Browser notification
              if (Notification.permission === 'granted') {
                new Notification('New Order!', {
                  body: `Order #${payload.new.order_number} - $${payload.new.total_amount}`
                });
              }
            }
            queryClient.invalidateQueries(['storefront-orders']);
          })
          .subscribe();
        
        return () => supabase.removeChannel(channel);
      }, [tenantId]);

      ```


      ### 2. Order status workflow

      - pending → confirmed → preparing → ready → delivered/picked_up

      - Each transition sends notification to customer

      - Cancel option with reason


      ### 3. Order detail modal

      - Full customer info

      - All items with images

      - Delivery address (if delivery)

      - Payment status

      - Timeline of status changes

      - Print receipt button


      ### 4. Bulk actions

      - Confirm all pending

      - Export to CSV

      - Print all receipts
    acceptance_criteria:
      - Real-time updates work
      - Sound plays on new order
      - Status changes update customer
      - Order details complete
    completed: true
  - id: complete-storefront-themes
    title: Complete Storefront Theme System with Custom CSS
    priority: P1
    estimated_minutes: 30
    description: >
      ## File: src/lib/storefrontThemes.ts


      Add custom theme builder:


      ```typescript

      interface CustomTheme {
        id: 'custom';
        name: 'Custom Theme';
        variables: {
          // Colors
          '--storefront-bg': string;
          '--storefront-text': string;
          '--storefront-primary': string;
          '--storefront-accent': string;
          '--storefront-muted': string;
          '--storefront-border': string;
          
          // Typography
          '--storefront-font-heading': string;
          '--storefront-font-body': string;
          '--storefront-font-size-base': string;
          
          // Spacing
          '--storefront-radius': string;
          '--storefront-spacing': string;
          
          // Effects
          '--storefront-shadow': string;
          '--storefront-blur': string;
        };
        customCSS: string; // Raw CSS for advanced users
      }

      ```


      ## Add theme editor UI:


      ```typescript

      const ThemeEditor = () => {
        const [theme, setTheme] = useState(customTheme);
        
        return (
          <div className="space-y-6">
            {/* Color pickers */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Background Color</Label>
                <ColorPicker
                  value={theme.variables['--storefront-bg']}
                  onChange={v => updateVariable('--storefront-bg', v)}
                />
              </div>
              <div>
                <Label>Primary Color</Label>
                <ColorPicker
                  value={theme.variables['--storefront-primary']}
                  onChange={v => updateVariable('--storefront-primary', v)}
                />
              </div>
              {/* ... more colors */}
            </div>
            
            {/* Font selector */}
            <div>
              <Label>Heading Font</Label>
              <Select
                value={theme.variables['--storefront-font-heading']}
                onValueChange={v => updateVariable('--storefront-font-heading', v)}
              >
                <SelectItem value="Inter">Inter</SelectItem>
                <SelectItem value="Playfair Display">Playfair Display</SelectItem>
                <SelectItem value="Montserrat">Montserrat</SelectItem>
              </Select>
            </div>
            
            {/* Custom CSS */}
            <div>
              <Label>Custom CSS (Advanced)</Label>
              <Textarea
                value={theme.customCSS}
                onChange={e => setTheme({ ...theme, customCSS: e.target.value })}
                placeholder=".storefront-card { box-shadow: ... }"
                rows={10}
              />
            </div>
          </div>
        );
      };

      ```
    acceptance_criteria:
      - Color pickers work
      - Font selection works
      - Custom CSS applies
      - Theme saves and loads
    completed: true
  - id: add-storefront-seo
    title: Add Storefront SEO and Social Sharing
    priority: P2
    estimated_minutes: 25
    description: >
      ## File: src/pages/shop/StorefrontPage.tsx


      Add SEO meta tags:


      ```typescript

      import { Helmet } from 'react-helmet-async';


      const StorefrontPage = () => {
        const { store } = useStore();
        
        return (
          <>
            <Helmet>
              <title>{store.meta_title || store.name}</title>
              <meta name="description" content={store.meta_description || store.description} />
              
              {/* Open Graph */}
              <meta property="og:title" content={store.name} />
              <meta property="og:description" content={store.description} />
              <meta property="og:image" content={store.og_image || store.logo} />
              <meta property="og:url" content={`https://floraiq.com/shop/${store.slug}`} />
              <meta property="og:type" content="website" />
              
              {/* Twitter */}
              <meta name="twitter:card" content="summary_large_image" />
              <meta name="twitter:title" content={store.name} />
              <meta name="twitter:description" content={store.description} />
              <meta name="twitter:image" content={store.og_image || store.logo} />
              
              {/* Schema.org */}
              <script type="application/ld+json">
                {JSON.stringify({
                  "@context": "https://schema.org",
                  "@type": "Store",
                  "name": store.name,
                  "description": store.description,
                  "url": `https://floraiq.com/shop/${store.slug}`,
                  "image": store.logo,
                })}
              </script>
            </Helmet>
            
            {/* Rest of page */}
          </>
        );
      };

      ```


      ## Add social share buttons:


      ```typescript

      const ShareButtons = ({ url, title }: { url: string; title: string }) => (
        <div className="flex gap-2">
          <Button variant="outline" size="icon" onClick={() => shareToTwitter(url, title)}>
            <Twitter className="h-4 w-4" />
          </Button>
          <Button variant="outline" size="icon" onClick={() => shareToFacebook(url)}>
            <Facebook className="h-4 w-4" />
          </Button>
          <Button variant="outline" size="icon" onClick={() => copyToClipboard(url)}>
            <Copy className="h-4 w-4" />
          </Button>
        </div>
      );

      ```
    acceptance_criteria:
      - Meta tags render correctly
      - OG tags work for social sharing
      - Schema markup validates
      - Share buttons work
    completed: true
  - id: final-build-verification
    title: Final Build Verification and Smoke Test
    priority: P0
    estimated_minutes: 30
    description: |
      Run final verification:

      ## 1. Build check
      ```bash
      npm run build
      ```
      Must complete with 0 errors.

      ## 2. Test auth flow
      - Go to /:tenantSlug/admin/login
      - Login with valid credentials
      - Verify redirect to dashboard
      - Navigate to each panel
      - Logout and verify redirect

      ## 3. Test storefront flow
      - Go to /shop/:storeSlug
      - Browse products
      - Add to cart
      - Checkout (test mode)
      - Verify order appears in admin

      ## 4. Test disposable menu flow
      - Create new menu in admin
      - Access menu link
      - Enter access code (if set)
      - Add products to cart
      - Place order
      - Manually burn menu
      - Verify 410 on burned menu

      ## 5. Create verification report
      Create docs/OVERNIGHT_BUILD_RESULTS.md with:
      - Build status
      - Auth flow test results
      - Storefront test results
      - Disposable menu test results
      - Any remaining issues
    acceptance_criteria:
      - npm run build succeeds
      - Auth flow works end-to-end
      - Storefront checkout works
      - Disposable menus work
      - Verification doc created
    completed: true
metadata:
  project: FloraIQ
  focus_areas:
    - Authentication system fixes
    - Admin panel interconnection
    - Disposable menus enhancement
    - Storefront complete buildout
  supabase_project_ref: mtvwmyerntkhrcdnhahp
  total_tasks: 20
  estimated_duration_hours: 10
  critical_files:
    auth:
      - src/contexts/TenantAdminAuthContext.tsx
      - src/pages/saas/LoginPage.tsx
      - supabase/functions/tenant-admin-auth/index.ts
    panels:
      - src/components/admin/AdminLayout.tsx
      - src/pages/admin/*.tsx
    menus:
      - src/components/admin/disposable-menus/*
      - src/pages/customer/SecureMenuAccess.tsx
      - supabase/functions/menu-*/index.ts
    storefront:
      - src/pages/admin/storefront/*
      - src/pages/shop/*
      - src/lib/storefrontThemes.ts
      - supabase/functions/storefront-checkout/index.ts
