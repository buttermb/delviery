name: FloraIQ 8-Hour Overnight Verification & Enhancement
description: Complete verification, security fixes, and feature enhancement for
  FloraIQ cannabis wholesale SaaS platform
version: 1.0.0
estimated_hours: 8
rules:
  - Use TypeScript strict mode
  - Follow existing component patterns in src/components
  - Use Supabase client from @/integrations/supabase/client
  - Always include tenant_id isolation in all database queries
  - Use TanStack Query patterns for data fetching
  - Follow shadcn/ui component conventions
  - Never modify existing database migrations, create new ones
  - Add proper error handling with toast notifications
  - Use the logger from @/lib/logger instead of console.log
tasks:
  - id: fix-vendor-management-ts-error
    title: Fix VendorManagement TypeScript Error TS2589
    priority: P0
    estimated_minutes: 15
    description: >
      Fix the TypeScript error "Type instantiation is excessively deep and
      possibly infinite" 

      in VendorManagement.tsx line 81.


      Root Cause: Supabase client's .update(formData) causes TypeScript to
      recursively 

      infer types from the massive types.ts (15,743 lines).


      File: src/pages/admin/VendorManagement.tsx


      Fix Pattern:

      - Line 81-85: Add explicit type cast to update operation

      - Line 94-99: Add explicit type cast to insert operation


      Code changes:

      ```typescript

      // For update (around line 81-85)

      const { error } = await supabase
        .from('vendors')
        .update(formData as Record<string, unknown>)
        .eq('id', editingVendor.id)
        .eq('tenant_id', tenant.id);

      // For insert (around line 94-99)

      const { error } = await supabase
        .from('vendors')
        .insert({
          ...formData,
          tenant_id: tenant.id
        } as Record<string, unknown>);
      ```
    acceptance_criteria:
      - Build completes without TS2589 error
      - Vendor create/update operations still work correctly
      - No type safety regressions in the component
    completed: true
  - id: fix-token-refresh-401
    title: Fix Token Refresh 401 Error
    priority: P0
    estimated_minutes: 30
    description: >
      Fix the 401 error occurring during token refresh that blocks all
      authenticated users.


      Files to modify:

      1. src/pages/saas/LoginPage.tsx - Clear stale tokens before login

      2. src/contexts/TenantAdminAuthContext.tsx - Guard against empty refresh
      tokens

      3. supabase/functions/tenant-admin-auth/index.ts - Ensure cookies set on
      refresh


      Changes needed:


      1. LoginPage.tsx - Add token clearing before signInWithPassword:

      ```typescript

      // Before login attempt

      localStorage.removeItem('sb-access-token');

      localStorage.removeItem('sb-refresh-token');

      document.cookie.split(";").forEach(c => {
        document.cookie = c.replace(/^ +/, "")
          .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
      });

      ```


      2. TenantAdminAuthContext.tsx - Add null check before refresh:

      ```typescript

      const refreshToken = async () => {
        const currentRefreshToken = localStorage.getItem('sb-refresh-token');
        if (!currentRefreshToken) {
          logout();
          return;
        }
        // ... existing refresh logic
      };

      ```


      3. Edge function - Verify Set-Cookie headers in refresh response
    acceptance_criteria:
      - Login works after clearing stale tokens
      - Token refresh succeeds with valid refresh token
      - 401 errors trigger proper logout instead of infinite retry
      - No blank screen on token expiration
    completed: true
  - id: create-atomic-pos-rpc
    title: Create Atomic POS Transaction RPC Function
    priority: P0
    estimated_minutes: 15
    description: >
      Create the missing create_pos_transaction_atomic database function for
      data integrity.


      Create new migration file:
      supabase/migrations/[timestamp]_create_pos_transaction_atomic.sql


      ```sql

      CREATE OR REPLACE FUNCTION public.create_pos_transaction_atomic(
        p_tenant_id UUID,
        p_items JSONB,
        p_payment_method TEXT,
        p_subtotal NUMERIC,
        p_tax_amount NUMERIC DEFAULT 0,
        p_discount_amount NUMERIC DEFAULT 0,
        p_customer_id UUID DEFAULT NULL,
        p_shift_id UUID DEFAULT NULL
      ) RETURNS JSONB

      LANGUAGE plpgsql

      SECURITY DEFINER

      SET search_path = public

      AS $$

      DECLARE
        v_transaction_id UUID;
        v_transaction_number TEXT;
        v_item JSONB;
        v_total NUMERIC;
      BEGIN
        -- Calculate total
        v_total := p_subtotal + p_tax_amount - p_discount_amount;
        
        -- Generate transaction number
        v_transaction_number := 'POS-' || to_char(now(), 'YYYYMMDD') || '-' || 
          lpad(floor(random() * 10000)::text, 4, '0');
        
        -- Create transaction
        INSERT INTO pos_transactions (
          tenant_id, 
          transaction_number, 
          subtotal, 
          tax_amount, 
          discount_amount,
          total_amount, 
          payment_method, 
          payment_status, 
          items, 
          customer_id, 
          shift_id,
          created_at
        )
        VALUES (
          p_tenant_id, 
          v_transaction_number, 
          p_subtotal, 
          p_tax_amount, 
          p_discount_amount,
          v_total, 
          p_payment_method, 
          'completed', 
          p_items, 
          p_customer_id, 
          p_shift_id,
          now()
        )
        RETURNING id INTO v_transaction_id;
        
        -- Update inventory atomically for each item
        FOR v_item IN SELECT * FROM jsonb_array_elements(p_items)
        LOOP
          UPDATE products
          SET 
            stock_quantity = stock_quantity - (v_item->>'quantity')::int,
            updated_at = now()
          WHERE id = (v_item->>'id')::uuid
            AND tenant_id = p_tenant_id
            AND stock_quantity >= (v_item->>'quantity')::int;
          
          -- Check if update succeeded (sufficient stock)
          IF NOT FOUND THEN
            RAISE EXCEPTION 'Insufficient stock for product %', v_item->>'id';
          END IF;
        END LOOP;
        
        RETURN jsonb_build_object(
          'success', true, 
          'transaction_number', v_transaction_number, 
          'transaction_id', v_transaction_id,
          'total', v_total
        );
      EXCEPTION
        WHEN OTHERS THEN
          RETURN jsonb_build_object(
            'success', false, 
            'error', SQLERRM
          );
      END;

      $$;


      -- Grant execute permission

      GRANT EXECUTE ON FUNCTION public.create_pos_transaction_atomic TO
      authenticated;

      ```
    acceptance_criteria:
      - Migration runs successfully
      - RPC function can be called from frontend
      - Transaction and inventory update happen atomically
      - Insufficient stock throws proper error and rolls back
      - Transaction number is unique
    completed: true
  - id: fix-vendors-rls
    title: Fix vendors table RLS policies
    priority: P1
    estimated_minutes: 10
    description: |
      Fix overly permissive RLS policies on vendors table.

      Create migration: supabase/migrations/[timestamp]_fix_vendors_rls.sql

      ```sql
      -- Drop permissive policies
      DROP POLICY IF EXISTS "Allow all for authenticated" ON vendors;
      DROP POLICY IF EXISTS "vendors_select" ON vendors;
      DROP POLICY IF EXISTS "vendors_insert" ON vendors;
      DROP POLICY IF EXISTS "vendors_update" ON vendors;
      DROP POLICY IF EXISTS "vendors_delete" ON vendors;

      -- Create tenant-isolated policies
      CREATE POLICY "vendors_tenant_select" ON vendors FOR SELECT
        USING (tenant_id IN (
          SELECT tu.tenant_id FROM tenant_users tu WHERE tu.user_id = auth.uid()
        ));

      CREATE POLICY "vendors_tenant_insert" ON vendors FOR INSERT
        WITH CHECK (tenant_id IN (
          SELECT tu.tenant_id FROM tenant_users tu WHERE tu.user_id = auth.uid()
        ));

      CREATE POLICY "vendors_tenant_update" ON vendors FOR UPDATE
        USING (tenant_id IN (
          SELECT tu.tenant_id FROM tenant_users tu WHERE tu.user_id = auth.uid()
        ));

      CREATE POLICY "vendors_tenant_delete" ON vendors FOR DELETE
        USING (tenant_id IN (
          SELECT tu.tenant_id FROM tenant_users tu WHERE tu.user_id = auth.uid()
        ));
      ```
    acceptance_criteria:
      - Old permissive policies removed
      - New policies enforce tenant isolation
      - Vendors CRUD still works for authorized users
      - Cross-tenant access is blocked
    completed: true
  - id: fix-products-rls
    title: Fix products table RLS policies
    priority: P1
    estimated_minutes: 10
    description: |
      Fix overly permissive RLS policies on products table.

      Create migration: supabase/migrations/[timestamp]_fix_products_rls.sql

      Apply same pattern as vendors table - drop permissive policies, 
      create tenant-isolated SELECT/INSERT/UPDATE/DELETE policies.

      Ensure the policy uses tenant_users lookup:
      ```sql
      USING (tenant_id IN (
        SELECT tu.tenant_id FROM tenant_users tu WHERE tu.user_id = auth.uid()
      ))
      ```
    acceptance_criteria:
      - Products are tenant-isolated
      - Product management works for authorized users
      - POS can still query products
    completed: true
  - id: fix-orders-rls
    title: Fix orders table RLS policies
    priority: P1
    estimated_minutes: 10
    description: |
      Fix overly permissive RLS policies on orders table.

      Create migration: supabase/migrations/[timestamp]_fix_orders_rls.sql

      Apply same tenant isolation pattern. Also need to consider:
      - Customer access to their own orders (customer_id = auth.uid())
      - Staff access to tenant orders

      ```sql
      -- Staff can see all tenant orders
      CREATE POLICY "orders_staff_select" ON orders FOR SELECT
        USING (tenant_id IN (
          SELECT tu.tenant_id FROM tenant_users tu WHERE tu.user_id = auth.uid()
        ));

      -- Customers can see their own orders
      CREATE POLICY "orders_customer_select" ON orders FOR SELECT
        USING (customer_id = auth.uid());
      ```
    acceptance_criteria:
      - Staff sees all tenant orders
      - Customers only see their own orders
      - Cross-tenant access blocked
    completed: true
  - id: fix-customers-rls
    title: Fix customers table RLS policies
    priority: P1
    estimated_minutes: 10
    description: |
      Fix overly permissive RLS policies on customers table.
      Apply tenant isolation pattern.
    acceptance_criteria:
      - Customers are tenant-isolated
      - Customer management works
    completed: true
  - id: fix-invoices-rls
    title: Fix invoices table RLS policies
    priority: P1
    estimated_minutes: 10
    description: |
      Fix overly permissive RLS policies on invoices table.
      Apply tenant isolation pattern.
    acceptance_criteria:
      - Invoices are tenant-isolated
      - Invoice generation/viewing works
    completed: true
  - id: fix-pos-transactions-rls
    title: Fix pos_transactions table RLS policies
    priority: P1
    estimated_minutes: 10
    description: |
      Fix overly permissive RLS policies on pos_transactions table.
      Apply tenant isolation pattern.
    acceptance_criteria:
      - POS transactions are tenant-isolated
      - Cash register operations work
      - Shift reports show correct data
    completed: true
  - id: fix-inventory-rls
    title: Fix inventory table RLS policies
    priority: P1
    estimated_minutes: 10
    description: |
      Fix overly permissive RLS policies on inventory table.
      Apply tenant isolation pattern.
    acceptance_criteria:
      - Inventory is tenant-isolated
      - Stock management works
    completed: true
  - id: fix-security-definer-functions
    title: Fix SECURITY DEFINER functions with mutable search_path
    priority: P1
    estimated_minutes: 15
    description: |
      Add SET search_path = public to all SECURITY DEFINER functions to prevent
      search_path injection attacks.

      Find all affected functions:
      ```sql
      SELECT proname, prosecdef 
      FROM pg_proc 
      WHERE prosecdef = true;
      ```

      For each function, add:
      ```sql
      ALTER FUNCTION function_name() SET search_path = public;
      ```

      Or recreate with SET search_path = public in the definition.
    acceptance_criteria:
      - All SECURITY DEFINER functions have immutable search_path
      - Linter warning count reduced
      - Functions still work correctly
    completed: true
  - id: verify-cash-register
    title: Verify and fix Cash Register functionality
    priority: P1
    estimated_minutes: 45
    description: >
      File: src/pages/admin/CashRegister.tsx


      Verification checklist:

      1. Product search works

      2. Add to cart works

      3. Quantity adjustment works

      4. Remove from cart works

      5. Payment method selection works

      6. Complete transaction works (use atomic RPC)

      7. Receipt generation works

      8. Inventory deduction is atomic

      9. Shift management works


      Known issues to fix:


      1. Line 112-159: Replace non-atomic inventory updates with RPC call

      ```typescript

      const completeTransaction = async () => {
        const { data, error } = await supabase.rpc('create_pos_transaction_atomic', {
          p_tenant_id: tenant.id,
          p_items: cart,
          p_payment_method: paymentMethod,
          p_subtotal: subtotal,
          p_tax_amount: taxAmount,
          p_discount_amount: discountAmount,
          p_customer_id: selectedCustomer?.id || null,
          p_shift_id: currentShift?.id || null
        });
        
        if (error || !data.success) {
          toast.error(data?.error || 'Transaction failed');
          return;
        }
        
        toast.success(`Transaction ${data.transaction_number} completed!`);
        // Clear cart, print receipt, etc.
      };

      ```


      2. Add loading states to all action buttons

      3. Add error boundary for crash recovery

      4. Ensure offline-first capability with queue
    acceptance_criteria:
      - All checkout flows complete successfully
      - Inventory accurately reflects sales
      - Receipts generate with correct totals
      - No data loss on network issues
    completed: true
  - id: verify-shift-management
    title: Verify Shift Management functionality
    priority: P1
    estimated_minutes: 30
    description: |
      File: src/components/pos/ShiftManager.tsx

      Verification checklist:
      1. Open shift works with starting cash
      2. Close shift works with cash count
      3. Shift calculates expected vs actual cash
      4. Variance is tracked
      5. Shift summary shows all transactions
      6. End-of-day reports generate correctly

      Ensure proper tenant isolation in all queries.
      Add validation for cash count (must be >= 0).
    acceptance_criteria:
      - Shifts open/close correctly
      - Cash variance calculated accurately
      - Reports show correct transaction sums
    completed: true
  - id: verify-orders-page
    title: Verify and fix Orders page functionality
    priority: P1
    estimated_minutes: 45
    description: >
      File: src/pages/admin/Orders.tsx


      Verification checklist:

      1. Orders list loads with real data

      2. Order status filtering works

      3. Single order status update works

      4. Bulk status change works

      5. Order details modal shows all items

      6. Customer name displays correctly

      7. Search functionality works

      8. Pagination works


      Known issues to fix:


      1. Line 126-138: Profile mapping may show empty names

      - Add fallback: customer?.name || customer?.email || 'Unknown Customer'


      2. Bulk status change missing tenant_id filter (SECURITY RISK):

      ```typescript

      // Line ~223-246: Add tenant isolation

      const { error } = await supabase
        .from('orders')
        .update({ 
          status,
          ...(status === 'delivered' && { delivered_at: new Date().toISOString() }),
          updated_at: new Date().toISOString()
        })
        .in('id', selectedOrders)
        .eq('tenant_id', tenant.id); // CRITICAL: Add this line!
      ```


      3. Add optimistic updates for better UX
    acceptance_criteria:
      - All order operations work correctly
      - Bulk operations respect tenant isolation
      - Customer names display properly
      - Status updates reflect immediately
    completed: true
  - id: verify-invoices-page
    title: Verify and fix Invoices page functionality
    priority: P1
    estimated_minutes: 45
    description: |
      File: src/pages/admin/InvoicesPage.tsx

      Verification checklist:
      1. Invoices list loads
      2. Create invoice works
      3. Edit invoice works
      4. Mark as paid works
      5. PDF download works (lines 97-129)
      6. Send invoice via email works
      7. Invoice stats are accurate (lines 163-175)

      Enhancements:
      1. Add tenant branding to PDF (logo, colors)
      2. Add line items detail to PDF
      3. Add payment terms to PDF
      4. Add due date calculation

      PDF generation improvements:
      ```typescript
      const generateInvoicePDF = async (invoice: Invoice) => {
        // Include tenant branding
        const tenant = await getTenantBranding();
        
        // Include detailed line items
        const lineItems = invoice.items.map(item => ({
          description: item.product_name,
          quantity: item.quantity,
          unit_price: item.unit_price,
          total: item.quantity * item.unit_price
        }));
        
        // Include payment terms
        const paymentTerms = tenant.payment_terms || 'Net 30';
        
        // Generate PDF with jspdf or similar
      };
      ```
    acceptance_criteria:
      - Invoice CRUD works correctly
      - PDFs generate with all required info
      - Email delivery works
      - Stats calculate accurately
    completed: true
  - id: verify-product-management
    title: Verify and fix Product Management functionality
    priority: P1
    estimated_minutes: 45
    description: |
      File: src/pages/admin/ProductManagement.tsx (1188 lines)

      Verification checklist:
      1. Product list loads
      2. Create product works
      3. Edit product works
      4. Delete product works (soft delete)
      5. Category filter works
      6. Search works
      7. Bulk price edit works
      8. Image upload works
      9. Potency limits alert works (lines 144-166)
      10. Stock quantity updates correctly

      Known issues to fix:

      1. Line 223-241: Add error handling for empty tenant
      ```typescript
      if (!tenant?.id) {
        toast.error('Tenant not found. Please refresh.');
        return;
      }
      ```

      2. Verify bulk operations have tenant isolation

      3. Add input validation for:
         - Price (must be >= 0)
         - Stock quantity (must be integer >= 0)
         - THC/CBD percentages (0-100)
         - SKU uniqueness within tenant
    acceptance_criteria:
      - All product CRUD operations work
      - Bulk operations are tenant-isolated
      - Validation prevents bad data
      - Images upload and display correctly
    completed: true
  - id: verify-inventory-management
    title: Verify and fix Inventory Management functionality
    priority: P1
    estimated_minutes: 45
    description: |
      File: src/pages/admin/InventoryManagement.tsx

      Verification checklist:
      1. Inventory dashboard loads
      2. Stock levels display correctly
      3. Low stock alerts work
      4. Stock adjustment dialog works
      5. Transfer between locations works
      6. Inventory value calculation is accurate

      Critical fix - Line 89-91: Remove hardcoded $3000/lb value
      ```typescript
      // BEFORE (hardcoded - wrong)
      const totalValue = 3000 * totalWeight;

      // AFTER (calculate from actual costs)
      const totalValue = products.reduce((sum, item) => {
        const cost = item.cost_per_unit || item.wholesale_price || 0;
        const quantity = Number(item.available_quantity || 0);
        return sum + (quantity * cost);
      }, 0);
      ```

      Additional improvements:
      1. Add inventory movement history
      2. Add batch/lot tracking display
      3. Add expiration date warnings
      4. Add FIFO/LIFO valuation option
    acceptance_criteria:
      - Stock levels accurate
      - Value calculations use actual costs
      - Low stock alerts trigger correctly
      - Stock adjustments log properly
    completed: true
  - id: verify-customer-management
    title: Verify and fix Customer Management functionality
    priority: P1
    estimated_minutes: 30
    description: >
      File: src/pages/admin/CustomerManagement.tsx


      Verification checklist:

      1. Customer list loads

      2. Create customer works

      3. Edit customer works

      4. Delete customer works (soft delete for those with orders)

      5. Customer type filter works

      6. Status filter works

      7. Encryption/decryption works (lines 110-136)

      8. Customer search works


      Issues to verify:

      1. Encryption key consistency after environment switch
         - May show ciphertext if keys don't match
         - Add graceful fallback to show encrypted indicator

      2. Soft delete logic (lines 162-183):

      ```typescript

      const deleteCustomer = async (customerId: string) => {
        // Check for existing orders
        const { data: orders } = await supabase
          .from('orders')
          .select('id')
          .eq('customer_id', customerId)
          .eq('tenant_id', tenant.id)
          .limit(1);
        
        if (orders?.length > 0) {
          // Soft delete - just mark as inactive
          await supabase
            .from('customers')
            .update({ status: 'inactive', deleted_at: new Date().toISOString() })
            .eq('id', customerId)
            .eq('tenant_id', tenant.id);
          toast.info('Customer archived (has order history)');
        } else {
          // Hard delete
          await supabase
            .from('customers')
            .delete()
            .eq('id', customerId)
            .eq('tenant_id', tenant.id);
          toast.success('Customer deleted');
        }
      };

      ```
    acceptance_criteria:
      - Customer CRUD works correctly
      - Sensitive data encrypted/decrypted properly
      - Soft delete preserves order history
      - Search finds customers by name/email/phone
    completed: true
  - id: verify-wholesale-operations
    title: Verify Wholesale Operations functionality
    priority: P1
    estimated_minutes: 45
    description: |
      Files:
      - src/pages/admin/WholesaleClients.tsx
      - src/pages/admin/WholesaleOrdersPage.tsx
      - src/pages/admin/NewWholesaleOrder.tsx

      Verification checklist:
      1. Wholesale clients list loads
      2. Create wholesale client works
      3. Client credit limits enforced
      4. Wholesale orders list loads
      5. Create wholesale order works
      6. Order pipeline drag-and-drop works
      7. Invoice generation from order works
      8. Payment recording works
      9. Pricing tiers apply correctly

      Ensure all operations respect tenant isolation.

      Add validation:
      - Order total cannot exceed client credit limit
      - Payment amount cannot exceed order balance
      - Minimum order quantities enforced
    acceptance_criteria:
      - All wholesale workflows complete
      - Credit limits enforced
      - Invoices generate from orders
      - Payments record and reflect correctly
    completed: true
  - id: deploy-edge-functions
    title: Deploy all 159 Edge Functions to production
    priority: P2
    estimated_minutes: 30
    description: |
      Deploy all edge functions to external Supabase project.

      Commands:
      ```bash
      supabase link --project-ref mtvwmyerntkhrcdnhahp
      supabase functions deploy
      ```

      Verify deployment status for each function.
      Check logs for any startup errors.
    acceptance_criteria:
      - All 159 functions deployed
      - No deployment errors
      - Functions respond to health checks
    completed: true
  - id: verify-critical-edge-functions
    title: Verify critical Edge Functions
    priority: P2
    estimated_minutes: 20
    description: |
      Test each critical edge function:

      1. validate-tenant
      ```bash
      curl -X POST https://[project].supabase.co/functions/v1/validate-tenant \
        -H "Content-Type: application/json" \
        -d '{"slug":"willysbo"}'
      ```

      2. tenant-admin-auth?action=login
      - Test login flow through UI

      3. tenant-admin-auth?action=refresh
      - Test token refresh

      4. check-stripe-config
      - Verify Stripe connection

      5. process-payment
      - Test with Stripe test mode

      6. send-notification
      - Test email delivery

      7. menu-generate
      - Test disposable menu creation

      8. menu-order-place
      - Test menu ordering flow
    acceptance_criteria:
      - All critical functions return expected responses
      - Error handling works properly
      - Rate limiting in place
    completed: true
  - id: verify-edge-function-secrets
    title: Verify all Edge Function secrets configured
    priority: P2
    estimated_minutes: 10
    description: |
      Verify all required secrets are set in external project:

      ```bash
      supabase secrets list --project-ref mtvwmyerntkhrcdnhahp
      ```

      Required secrets:
      - JWT_SECRET
      - SUPABASE_SERVICE_ROLE_KEY
      - STRIPE_SECRET_KEY
      - STRIPE_WEBHOOK_SECRET
      - RESEND_API_KEY
      - MAPBOX_ACCESS_TOKEN
      - CLERK_SECRET_KEY
      - CLERK_WEBHOOK_SECRET
      - REDIS_HOST
      - REDIS_PASSWORD
      - REDIS_PORT
      - ENCRYPTION_KEY

      Set any missing secrets:
      ```bash
      supabase secrets set SECRET_NAME=value --project-ref mtvwmyerntkhrcdnhahp
      ```
    acceptance_criteria:
      - All required secrets present
      - No functions failing due to missing env vars
    completed: true
  - id: e2e-testing-flow
    title: Run End-to-End Testing Flow
    priority: P2
    estimated_minutes: 30
    description: |
      Complete E2E testing sequence:

      1. Login Test:
         - Clear browser storage completely
         - Login as alex@gmail.com
         - Verify dashboard loads
         - Verify tenant context correct

      2. Dashboard Test:
         - All widgets show real data
         - No loading spinners stuck
         - Charts render correctly

      3. Product Flow:
         - Create new product with all fields
         - Add product to POS cart
         - Complete sale
         - Verify inventory deducted
         - Check transaction in reports

      4. Order Flow:
         - Create new order
         - Update status through pipeline
         - Generate invoice
         - Mark invoice as paid
         - Verify financials

      5. Customer Flow:
         - Create new customer
         - Place order for customer
         - View customer order history
         - Verify data encrypted at rest

      Document any issues found with screenshots/logs.
    acceptance_criteria:
      - All flows complete without errors
      - Data persists correctly
      - No console errors
      - Performance acceptable (<3s page loads)
    completed: true
  - id: remove-debug-code
    title: Remove debug code and console.logs
    priority: P3
    estimated_minutes: 15
    description: |
      Search and remove excessive logging:

      ```bash
      grep -r "console.log" src/ --include="*.tsx" --include="*.ts"
      grep -r "console.error" src/ --include="*.tsx" --include="*.ts"
      grep -r "console.warn" src/ --include="*.tsx" --include="*.ts"
      ```

      Replace with logger from @/lib/logger for production-safe logging:

      ```typescript
      import { logger } from '@/lib/logger';

      // Instead of console.log
      logger.debug('message', { data });

      // Instead of console.error
      logger.error('message', { error });
      ```

      Also remove:
      - Commented out code blocks
      - TODO comments that are done
      - Debug conditional renders
      - Test data hardcoded in components
    acceptance_criteria:
      - No console.log in production code
      - Logger used consistently
      - No debug cruft remaining
    completed: true
  - id: create-verification-docs
    title: Create verification results documentation
    priority: P3
    estimated_minutes: 15
    description: |
      Create docs/OVERNIGHT_VERIFICATION_RESULTS.md containing:

      # FloraIQ Overnight Verification Results

      ## Date: [DATE]

      ## Summary
      - Total tasks: X
      - Completed: X
      - Issues found: X
      - Issues fixed: X

      ## Features Tested

      ### POS / Cash Register
      - [ ] Product search
      - [ ] Cart operations
      - [ ] Payment processing
      - [ ] Receipt generation
      - [ ] Shift management

      ### Orders
      - [ ] Order listing
      - [ ] Status updates
      - [ ] Bulk operations

      ### Invoices
      - [ ] Invoice CRUD
      - [ ] PDF generation
      - [ ] Email delivery

      ### Products
      - [ ] Product CRUD
      - [ ] Category filtering
      - [ ] Image upload
      - [ ] Stock management

      ### Inventory
      - [ ] Stock levels
      - [ ] Adjustments
      - [ ] Valuation

      ### Customers
      - [ ] Customer CRUD
      - [ ] Encryption
      - [ ] Order history

      ### Wholesale
      - [ ] Client management
      - [ ] Order pipeline
      - [ ] Invoicing

      ## Bugs Found
      1. [Bug description] - Fixed/Open

      ## Performance Notes
      - Page load times
      - Query performance
      - Bundle size

      ## Remaining Issues
      1. [Issue description]

      ## Recommendations
      1. [Recommendation]
    acceptance_criteria:
      - Documentation complete
      - All tested features documented
      - Issues tracked with status
    completed: true
metadata:
  project: FloraIQ
  type: verification-enhancement
  target_environment: production
  supabase_project_ref: mtvwmyerntkhrcdnhahp
  priority_summary:
    P0:
      - Build error fix (15 min)
      - Auth token refresh (30 min)
      - Atomic POS RPC (15 min)
    P1:
      - RLS security fixes (75 min)
      - Core features verification (285 min)
    P2:
      - Edge function deployment (60 min)
      - E2E testing (30 min)
    P3:
      - Cleanup and documentation (30 min)
  estimated_files_modified: 25-35
  key_files:
    build_fix:
      - src/pages/admin/VendorManagement.tsx
    auth_fixes:
      - src/pages/saas/LoginPage.tsx
      - src/contexts/TenantAdminAuthContext.tsx
      - supabase/functions/tenant-admin-auth/index.ts
    security:
      - supabase/migrations/ (10+ new migration files)
    core_features:
      - src/pages/admin/CashRegister.tsx
      - src/pages/admin/Orders.tsx
      - src/pages/admin/InvoicesPage.tsx
      - src/pages/admin/ProductManagement.tsx
      - src/pages/admin/InventoryManagement.tsx
      - src/pages/admin/CustomerManagement.tsx
      - src/pages/admin/WholesaleClients.tsx
      - src/pages/admin/WholesaleOrdersPage.tsx
    edge_functions:
      - supabase/functions/ (159 functions)
