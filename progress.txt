## Task: Optimize Database Queries

### What was done:
Comprehensive database query optimization across 8 hook files and 3 page components, addressing:
- Column selection optimization (replacing `select('*')` with explicit columns)
- N+1 query elimination (replacing separate lookups with JOINs)
- Cache configuration (adding staleTime/gcTime to all queries)
- Count-only queries (using `{ count: 'exact', head: true }` instead of fetching rows)
- Result limiting (adding `.limit()` to unbounded list queries)
- Type safety improvements (removing `any` types)

### Specific Optimizations:

1. **CRM Hooks** (`src/hooks/crm/useClients.ts`, `useInvoices.ts`, `useCRMDashboard.ts`):
   - Replaced `select('*')` with explicit column lists in all queries
   - Added `staleTime: 30_000` and `gcTime: 300_000` to all useQuery calls
   - Replaced `any[]` type with proper `ActivityLogEntry` interface in dashboard metrics
   - Optimized client search to return only needed columns

2. **useAdminBadgeCounts** (`src/hooks/useAdminBadgeCounts.ts`):
   - Converted 5 queries from fetching full rows to count-only (`{ count: 'exact', head: true }`)
   - Eliminates transferring potentially thousands of rows just to count them
   - ~99% reduction in data transfer for badge count queries

3. **useWholesaleData** (`src/hooks/useWholesaleData.ts`):
   - Added explicit column selection to all 8 query hooks
   - Fixed N+1 pattern in `useWholesalePayments` (replaced separate client fetch with JOIN)
   - Added `.limit(100)` to orders, deliveries, and payments queries
   - Added staleTime (15-60s) and gcTime to all hooks

4. **useFinancialData** (`src/hooks/useFinancialData.ts`):
   - Added `staleTime: 60_000` and `gcTime: 300_000` to snapshot, cash flow, and credit hooks
   - Added `staleTime: 120_000` and `gcTime: 600_000` to monthly performance (less volatile data)

5. **useDisposableMenus** (`src/hooks/useDisposableMenus.ts`):
   - Replaced `menu_orders(*)` with `menu_orders(id, total_amount)` (only fields used for stats)
   - Added explicit column selection to main menu query
   - Optimized `useMenuWhitelist` to select specific client columns instead of `wholesale_clients(*)`
   - Added column selection and `.limit(100)` to `useMenuOrders`
   - Replaced `any` types with proper typed interfaces

6. **Orders.tsx** (`src/pages/admin/Orders.tsx`):
   - Replaced `select('*, order_items(*)')` with explicit columns
   - Added `.limit(100)` to prevent unbounded result sets
   - Added `staleTime: 15_000` and `gcTime: 120_000`

7. **InventoryManagement.tsx** (`src/pages/admin/InventoryManagement.tsx`):
   - Replaced `select('*')` with only the 12 columns used by the Product interface

8. **CustomerManagement.tsx** (`src/pages/admin/CustomerManagement.tsx`):
   - Replaced `select('*')` with only the 16 columns needed for customer display/encryption

9. **Build fix** (`src/lib/utils/sanitize.ts`):
   - Added missing `sanitizeBasicHtml` export that was blocking production builds

### Performance Impact Estimates:
- **Data transfer**: ~50-80% reduction per query (only fetching needed columns)
- **Badge counts**: ~99% reduction (count-only vs fetching all rows)
- **N+1 elimination**: 1 query instead of 2 for wholesale payments
- **Cache hits**: 30-120s staleTime prevents redundant refetches on component remounts
- **Memory usage**: Significant reduction from smaller response payloads

### Files Changed:
- `src/hooks/crm/useClients.ts`
- `src/hooks/crm/useInvoices.ts`
- `src/hooks/crm/useCRMDashboard.ts`
- `src/hooks/useAdminBadgeCounts.ts`
- `src/hooks/useWholesaleData.ts`
- `src/hooks/useFinancialData.ts`
- `src/hooks/useDisposableMenus.ts`
- `src/pages/admin/Orders.tsx`
- `src/pages/admin/InventoryManagement.tsx`
- `src/pages/admin/CustomerManagement.tsx`
- `src/lib/utils/sanitize.ts` (build fix)

---

## Task: Add Breadcrumb Navigation Between Panels

### What was done:
1. Created `src/components/admin/Breadcrumbs.tsx` - A dedicated breadcrumb navigation component that:
   - Shows Home icon linking to Dashboard
   - Parses URL path segments into readable breadcrumb labels
   - Uses a comprehensive SEGMENT_LABELS map for human-readable display names (hubs, pages, etc.)
   - Falls back to Title Case formatting for unknown segments
   - Highlights current page (non-clickable, bold font)
   - All intermediate segments are clickable links for navigation
   - Hides on dashboard (root) since it's unnecessary there
   - Uses proper aria attributes for accessibility

2. Updated `src/pages/admin/AdminLayout.tsx` to:
   - Replace inline breadcrumb logic with the new `Breadcrumbs` component
   - Remove unused imports (Link, useNavigate, ChevronRight)
   - Simplify mobile title display using a local helper function
   - Breadcrumbs now show on all admin pages via the shared layout

### Acceptance Criteria Met:
- [x] Breadcrumbs show on all admin pages (via AdminLayout integration)
- [x] Links navigate correctly (each intermediate segment links to proper admin route)
- [x] Current page highlighted (font-medium, text-foreground, non-clickable)

### Files Changed:
- `src/components/admin/Breadcrumbs.tsx` (new)
- `src/pages/admin/AdminLayout.tsx` (modified)

---

## Task: Fix Mobile Navigation Issues

### What was done:

1. **Fixed z-index conflicts between admin mobile nav components**
   - Reduced `MobileBottomNav` (admin) z-index from 100 to 50 to align with design system
   - Removed unused `MobileNav` import from `AdminLayout.tsx` (was imported but never rendered, had conflicting z-index of 50)
   - Removed unused `Input` import from `AdminLayout.tsx`

2. **Fixed LuxuryNav mobile menu overlay positioning**
   - Changed from fixed `top-20` to dynamic `top-16`/`top-20` based on scroll state (nav shrinks on scroll)
   - Added backdrop overlay for dismissing menu by tapping outside
   - Added `maxHeight: calc(100dvh - 5rem)` to prevent content overflow off-screen
   - Improved animation from height-based to y-translate for smoother 60fps transitions

3. **Fixed global `max-width: 100%` CSS rule**
   - Removed overly aggressive `* { max-width: 100% }` that broke tables, carousels, and scrollable content
   - Replaced with scoped `body > #root { max-width: 100vw; overflow-x: hidden }` to contain only the root

4. **Fixed double padding issue in admin layout**
   - Admin `<main>` had both Tailwind `pb-24` AND global CSS `padding-bottom: max(100px, ...)` via `@media`
   - Added `custom-mobile-padding` class to opt out of the global CSS rule
   - Retained Tailwind `pb-24 lg:pb-6` for proper responsive padding

5. **Fixed shop MobileBottomNav safe areas and theme support**
   - Replaced hardcoded `bg-white` with `bg-background/95 backdrop-blur-md` for dark mode support
   - Replaced non-standard `safe-area-pb` class with proper `env(safe-area-inset-bottom)` inline style
   - Increased touch targets from 44px to 48px minimum (iOS/Android accessibility guidelines)
   - Added `touch-manipulation` and `active:scale-95` for responsive touch feedback
   - Added proper `aria-label` attributes to navigation links
   - Removed default export (project convention: named exports only)

6. **Added route-change close behavior to all mobile menus**
   - LuxuryNav: Added `useLocation` + `useEffect` to close menu on pathname change
   - ShopLayout (default theme): Added `useLocation` + `useEffect` to close menu on pathname change

7. **Added body scroll lock when mobile menus are open**
   - LuxuryNav: Sets `document.body.style.overflow = 'hidden'` when menu opens
   - ShopLayout (default theme): Same scroll lock pattern
   - Both properly clean up on unmount via effect cleanup

8. **Improved ShopLayout default theme mobile menu accessibility**
   - Added `role="navigation"` and `aria-label` to mobile nav element
   - Increased touch targets to 44px minimum (`min-h-[44px]`, `py-3`)
   - Added `touch-manipulation` and `active:scale-[0.98]` for responsive feedback

9. **Fixed pre-existing build error**
   - Added `sanitizeBasicHtml` export to `src/lib/utils/sanitize.ts` (was imported by HeroSection but not exported)

### Acceptance Criteria Met:
- [x] Mobile navigation menus close on route change (LuxuryNav, ShopLayout)
- [x] Body scroll is locked when mobile menus are open
- [x] Safe area insets properly handled on all mobile navs (notch/home indicator)
- [x] Touch targets meet 44-48px minimum accessibility guidelines
- [x] Z-index values consistent (50 for bottom nav, no conflicts)
- [x] No hardcoded colors that break dark mode
- [x] LuxuryNav overlay positions correctly relative to nav height on scroll
- [x] Build passes without TypeScript errors

### Files Changed:
- `src/components/admin/MobileBottomNav.tsx` (z-index fix, safe area fix)
- `src/components/shop/MobileBottomNav.tsx` (theme support, safe areas, touch targets, accessibility)
- `src/components/shop/LuxuryNav.tsx` (menu positioning, route-close, scroll lock, backdrop)
- `src/pages/admin/AdminLayout.tsx` (removed unused imports, fixed double padding)
- `src/pages/shop/ShopLayout.tsx` (route-close, scroll lock, touch targets, accessibility)
- `src/index.css` (scoped global max-width rule)
- `src/lib/utils/sanitize.ts` (added sanitizeBasicHtml export to fix build)
