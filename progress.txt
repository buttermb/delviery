- Tenants relation provides store business_name
- Status timeline handles cancelled state separately
- Boolean(shouldFetch) ensures enabled is strictly boolean for useQuery

## task-207: Create delivery runner mobile view
- Created src/pages/mobile/RunnerView.tsx with mobile-optimized UI for delivery runners
- Shows assigned deliveries in route order with numbered badges
- Each delivery card displays customer name, address, items, special instructions, total amount
- Navigate button opens Google Maps (Android) or Apple Maps (iOS) with address or coordinates
- Call button allows direct phone call to customer
- Status update buttons: Pick Up -> Start Delivery -> Delivered (using mutation pattern)
- Photo proof of delivery modal with camera capture and delivery notes
- Offline support with localStorage queue for status updates
- Auto-sync offline queue when connection restored
- Supabase realtime subscription for live delivery updates
- Used useOnlineStatus hook for connection detection
- Maps delivery status from orders table to delivery status types
- Expandable delivery cards show full item list and instructions

## task-208: Create delivery notification chain
- Created src/hooks/useDeliveryNotifications.ts for automated delivery notifications
- Follows useNotificationDispatcher and useOrderStatusNotification patterns
- Listens to delivery_status_changed events from eventBus
- Notification chain by status:
  - assigned: Notifies runner with customer info and order number
  - picked_up: Notifies customer "Your order is on its way!" + optional SMS
  - nearby: Geo-proximity notification "Your delivery is almost there!" + optional SMS
  - delivered: Notifies customer + admin of completion + optional SMS
  - failed/cancelled: Notifies admin, cancelled also notifies customer
- SMS notifications via existing send-sms Edge Function (Twilio)
- checkNearbyAndNotify() calculates Haversine distance between runner and customer
- nearbyThresholdMeters config (default 500m) for proximity triggering
- Uses Set to prevent duplicate nearby notifications per delivery
- Fetches delivery info from unified_orders with fallback to orders table
- All queries filter by tenant_id for multi-tenant isolation
- ESLint warning fixed by copying ref value for cleanup function
- Publishes notification_sent event after each notification


## task-209: Create delivery proof of delivery
- Created src/components/admin/delivery/ProofOfDelivery.tsx for capturing proof of delivery
- Component captures photo evidence, customer signature, recipient name, and delivery notes
- Uses react-signature-canvas for signature capture on canvas
- Photo upload supports both file selection and device camera capture
- Form validation with react-hook-form + zod schema
- Geolocation capture for delivery location verification (lat/lng with accuracy)
- Uploads images to Supabase Storage "delivery-proofs" bucket
- Stores proof in delivery_proofs table (with graceful fallback if table doesn't exist yet)
- Generates text-based delivery receipt for compliance documentation
- Compliance alert reminds runner of age verification (21+) requirements
- Uses useTenantAdminAuth for tenant context (tenant_id filtering)
- DeliveryProofData interface exported for consumer components
- All logging via logger from @/lib/logger — no console.log
- Proper error handling with toast notifications
- Loading states during submission and location capture
- Tabs UI separates photo and signature capture for better mobile UX

## 2026-02-12 06:13:52 - DeliveryScheduler Component
Created src/components/admin/delivery/DeliveryScheduler.tsx
- Calendar view showing scheduled deliveries by week
- Time slot management with capacity limits per slot
- Slot availability visualization with utilization percentages
- Block full slots automatically
- CRUD operations for time slot configuration
- Created migration 20260212120000_add_delivery_time_slots.sql with RLS policies
- Uses useTenantContext for tenant isolation
- Uses TanStack Query with proper queryKeys
- Follows all FloraIQ coding conventions

## task-216: Create delivery runner performance tracking
- Created `src/hooks/useRunnerMetrics.ts` with three main hooks:
  - `useRunnerMetrics(options)`: Fetches individual runner performance metrics
  - `useWeeklyPerformanceReport(weekOffset)`: Generates weekly team performance reports
  - `useRunnerLeaderboard(options)`: Returns ranked list of runners by composite score
- Metrics tracked:
  - Deliveries completed (total and weekly)
  - Average delivery time (from pickup to delivery)
  - On-time rate (within 60 minutes threshold)
  - Customer ratings (from runner.rating field)
  - Exceptions count (from delivery_exceptions table)
  - Distance covered (calculated via Haversine formula from location history)
  - Week-over-week change percentage
- Created supporting components:
  - `RunnerMetricsPanel`: Displays individual runner metrics (full and compact modes)
  - `WeeklyPerformanceReport`: Weekly team report with runner breakdown and insights
  - `RunnerLeaderboard`: Ranked runner list with period selector (week/month/all)
- Extended `queryKeys.runners` with `metrics`, `leaderboard`, and `weeklyReport` factories
- All queries filter by `tenant_id` via `useTenantContext()`
- Used `logger` from `@/lib/logger` for all debug/error logging
- Composite score formula: 30% deliveries + 30% on-time + 20% avg time + 20% rating
- Error handling for missing tables (delivery_exceptions, runner_location_history)
- Components export from `src/components/admin/delivery/index.ts`

## task-210: Create Supabase migration for delivery_proofs table
- Migration file already exists at supabase/migrations/add_delivery_proofs.sql
- Contains: id, tenant_id, delivery_id, order_id, photo_url, signature_url, recipient_name, notes, location_lat, location_lng, captured_at, created_at
- RLS policies for tenant isolation implemented
- Marked as passes: true

## task-217: Create delivery compliance checks
- Four files implemented: types (`src/types/delivery-compliance.ts`), hook (`src/hooks/useDeliveryCompliance.ts`), component (`src/components/admin/delivery/DeliveryComplianceChecklist.tsx`), migration (`supabase/migrations/20260212130000_create_delivery_compliance_checks.sql`)
- Six compliance check types: age_verification, id_on_file, licensed_zone, time_restriction, quantity_limit, customer_status
- Hook provides: fetch checks, create/verify/override mutations, batch initialization, auto-verify system checks, can_complete_delivery RPC
- Component features: progress bar, collapsible check details, manual verify/fail buttons, admin override dialog with reason, audit log viewer, blocking alert
- Migration includes: delivery_compliance_checks table, delivery_compliance_audit_log table, RLS policies, trigger-based audit logging, can_complete_delivery RPC function
- Fixed rule violations: changed .single() to .maybeSingle() (3 occurrences), fixed import ordering (React -> Third-party -> Types -> Components -> Utils), removed unused queryKeys import, moved sonner import to third-party group, separated DEFAULT_COMPLIANCE_SETTINGS value import from type imports
- Exported DeliveryComplianceChecklist from delivery barrel file (index.ts)
- TypeScript compilation passes with no errors
- Marked as passes: true

## CartPage displays items with quantity controls and order summary
- CartPage already fully implemented at src/pages/shop/CartPage.tsx (690 lines)
- Lazy import at src/routes/lazyImports.ts:189, route at /shop/:storeSlug/cart in App.tsx:335
- Features verified present:
  - Cart items display: product image, name, variant, price, Metrc ID, stock warnings
  - Quantity controls: +/- buttons with animated display, desktop and mobile (44px touch targets)
  - Order summary: subtotal, delivery fee (with free delivery progress bar), coupon/deal discounts, total
  - Coupon code input and application via useShopCart hook
  - Active deals display via useDeals hook
  - Price sync with server on mount and real-time price change events
  - Stock validation before checkout via checkInventoryAvailability
  - Express checkout buttons, express checkout link
  - Swipeable cart items on mobile (SwipeableCartItem component)
  - Empty cart state with animated icon and "Continue Shopping" CTA
  - Sticky mobile checkout bar with item count and total
  - Luxury and default theme support via useLuxuryTheme hook
  - Upsells section (CartUpsellsSection) for related products
  - Clear all cart functionality
- TypeScript compilation passes with zero errors
- No implementation changes needed — feature was already complete

## Product Grid section edit dialog has all fields and saves correctly
- Updated ProductGridEditor in SectionEditors.tsx with new "Grid Settings" accordion section
- Added fields: columns (2/3/4), max_products (4-50), sort_order (newest/price/name), category_filter (all/flower/edibles/pre-rolls/concentrates/vapes), show_view_all_link toggle
- Updated sectionDefaults() in storefront-builder.config.ts to include new default values for all product grid content fields
- Updated ProductGridSectionProps interface with new fields: columns, max_products, sort_order, show_view_all_link, category_filter
- Updated ProductGridSection component to apply: category filtering, sort ordering, max product limits, dynamic grid columns, and "View All Products" button when products exceed max
- TypeScript compilation passes with zero errors

## Checkout handler creates order in database with server-side price validation
- Verified existing storefront-checkout edge function already performs server-side price validation:
  - Fetches product prices from DB (never trusts client prices)
  - Stock validation with all-or-nothing check
  - Per-item and total price discrepancy detection (>0.01 tolerance)
  - Delivery fee calculated server-side from store settings
  - Builds orderItems with server-fetched prices
- Verified create_marketplace_order RPC handles: idempotency, FOR UPDATE locks, checked inventory deduction
- Created migration 20260228000016_order_items_from_rpc.sql:
  - Updated create_marketplace_order RPC to INSERT into marketplace_order_items table
  - Each item gets a normalised row with server-validated unit_price and total_price
  - Items are inserted AFTER order creation but BEFORE inventory deduction
  - If inventory deduction fails (race condition), the entire transaction rolls back (including order items)
  - This ensures marketplace_order_items has relational integrity and queryable server-validated prices
- TypeScript compilation passes with zero errors

## Create next_order_number RPC function
- Migration already exists at supabase/migrations/20260228000007_create_next_order_number_rpc.sql
- Function: public.next_order_number(p_tenant_id UUID) RETURNS INTEGER
- Uses pg_advisory_xact_lock(hashtext('orders_' || p_tenant_id::text)) for race condition safety
- Queries SELECT COALESCE(MAX(order_number::INTEGER), 1000) + 1 FROM orders WHERE tenant_id = p_tenant_id
- Only considers numeric order_number values (WHERE order_number ~ '^\d+$')
- SECURITY DEFINER with SET search_path = public
- GRANT EXECUTE to authenticated role
- Complements the existing next_tenant_order_number() which handles marketplace_orders via tenant_order_sequences table
- TypeScript compilation passes with zero errors
- No additional changes needed - migration was already committed (ffbf972f)
