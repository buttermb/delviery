## Fix Token Refresh Mechanism - Auto Refresh Before Expiry

### Status: COMPLETED

### What was done:

1. **Created `src/lib/auth/tokenRefresh.ts`** - A dedicated utility module that extracts and improves token refresh logic:
   - `isValidRefreshToken()` - Validates refresh tokens (checks for null, "undefined"/"null" strings, empty, too short)
   - `tokenNeedsRefresh()` - Checks if a token is within the refresh buffer window
   - `extractRefreshTokenFromCookies()` - Parses refresh token from cookie strings
   - `cleanupStaleAuthState()` - Removes stale auth keys from localStorage
   - `cleanupAuthCookies()` - Clears auth cookies by setting expiry in the past
   - `createRefreshTimer()` - **KEY FEATURE**: Creates a robust, visibility-aware refresh timer that handles:
     - Regular scheduled refresh (setTimeout before expiry)
     - Tab visibility changes (refreshes when tab becomes visible again)
     - Wake-from-sleep detection (detects time drift > 15s between checks)
     - Warning callback before expiry
     - Proper cleanup of all timers and event listeners
   - `createRefreshExecutor()` - Race-condition-safe wrapper that deduplicates concurrent refresh calls

2. **Updated `TenantAdminAuthContext.tsx`**:
   - Imported and integrated the new `createRefreshTimer` utility
   - Replaced inline `setupRefreshTimer` with the visibility-aware timer
   - Used `isValidRefreshToken()` for token validation (DRY)
   - Used `tokenNeedsRefresh()` in the periodic validation effect
   - Added `refreshTimerHandleRef` for proper lifecycle management
   - Maintained all existing functionality (race condition prevention, fallback to Supabase native refresh, session timeout warning)

3. **Updated `CustomerAuthContext.tsx`**:
   - Added visibility-aware proactive refresh (previously only verified, didn't actually refresh before expiry)
   - Uses `createRefreshTimer` for the same robust timer behavior
   - Maintains hourly safety-net interval as fallback
   - Properly handles token expiry detection and logout

4. **Updated `src/lib/auth/__tests__/tokenRefresh.test.ts`** (32 tests, all passing):
   - Tests now import and test the actual exported functions from `tokenRefresh.ts`
   - Added tests for `tokenNeedsRefresh()` with various scenarios
   - Added tests for `extractRefreshTokenFromCookies()` with custom cookie names
   - Added tests for `createRefreshTimer()`:
     - Triggers refresh before expiry
     - Refreshes immediately when near expiry
     - Doesn't trigger when plenty of time left
     - Calls onWarning before expiry
     - Cleans up timers on disposal
     - Detects visibility changes
     - Handles checkNow method
   - Added tests for `createRefreshExecutor()` race condition prevention
   - Kept existing fallback mechanism tests

### Key Improvements:
- **Visibility-aware refresh**: When a user returns to a backgrounded tab, the token is immediately checked and refreshed if needed
- **Wake-from-sleep detection**: If the machine sleeps and wakes, the timer detects the time drift and triggers a refresh check
- **Customer auth now has proactive refresh**: Previously only verified tokens; now refreshes before expiry
- **DRY code**: Common logic extracted to reusable utility functions
- **Better testability**: All core logic is now in a testable utility module

### Files Changed:
- `src/lib/auth/tokenRefresh.ts` (NEW)
- `src/contexts/TenantAdminAuthContext.tsx` (MODIFIED)
- `src/contexts/CustomerAuthContext.tsx` (MODIFIED)
- `src/lib/auth/__tests__/tokenRefresh.test.ts` (MODIFIED)
