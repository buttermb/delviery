- Tenants relation provides store business_name
- Status timeline handles cancelled state separately
- Boolean(shouldFetch) ensures enabled is strictly boolean for useQuery

## task-207: Create delivery runner mobile view
- Created src/pages/mobile/RunnerView.tsx with mobile-optimized UI for delivery runners
- Shows assigned deliveries in route order with numbered badges
- Each delivery card displays customer name, address, items, special instructions, total amount
- Navigate button opens Google Maps (Android) or Apple Maps (iOS) with address or coordinates
- Call button allows direct phone call to customer
- Status update buttons: Pick Up -> Start Delivery -> Delivered (using mutation pattern)
- Photo proof of delivery modal with camera capture and delivery notes
- Offline support with localStorage queue for status updates
- Auto-sync offline queue when connection restored
- Supabase realtime subscription for live delivery updates
- Used useOnlineStatus hook for connection detection
- Maps delivery status from orders table to delivery status types
- Expandable delivery cards show full item list and instructions

## task-208: Create delivery notification chain
- Created src/hooks/useDeliveryNotifications.ts for automated delivery notifications
- Follows useNotificationDispatcher and useOrderStatusNotification patterns
- Listens to delivery_status_changed events from eventBus
- Notification chain by status:
  - assigned: Notifies runner with customer info and order number
  - picked_up: Notifies customer "Your order is on its way!" + optional SMS
  - nearby: Geo-proximity notification "Your delivery is almost there!" + optional SMS
  - delivered: Notifies customer + admin of completion + optional SMS
  - failed/cancelled: Notifies admin, cancelled also notifies customer
- SMS notifications via existing send-sms Edge Function (Twilio)
- checkNearbyAndNotify() calculates Haversine distance between runner and customer
- nearbyThresholdMeters config (default 500m) for proximity triggering
- Uses Set to prevent duplicate nearby notifications per delivery
- Fetches delivery info from unified_orders with fallback to orders table
- All queries filter by tenant_id for multi-tenant isolation
- ESLint warning fixed by copying ref value for cleanup function
- Publishes notification_sent event after each notification


## task-209: Create delivery proof of delivery
- Created src/components/admin/delivery/ProofOfDelivery.tsx for capturing proof of delivery
- Component captures photo evidence, customer signature, recipient name, and delivery notes
- Uses react-signature-canvas for signature capture on canvas
- Photo upload supports both file selection and device camera capture
- Form validation with react-hook-form + zod schema
- Geolocation capture for delivery location verification (lat/lng with accuracy)
- Uploads images to Supabase Storage "delivery-proofs" bucket
- Stores proof in delivery_proofs table (with graceful fallback if table doesn't exist yet)
- Generates text-based delivery receipt for compliance documentation
- Compliance alert reminds runner of age verification (21+) requirements
- Uses useTenantAdminAuth for tenant context (tenant_id filtering)
- DeliveryProofData interface exported for consumer components
- All logging via logger from @/lib/logger — no console.log
- Proper error handling with toast notifications
- Loading states during submission and location capture
- Tabs UI separates photo and signature capture for better mobile UX

## 2026-02-12 06:13:52 - DeliveryScheduler Component
Created src/components/admin/delivery/DeliveryScheduler.tsx
- Calendar view showing scheduled deliveries by week
- Time slot management with capacity limits per slot
- Slot availability visualization with utilization percentages
- Block full slots automatically
- CRUD operations for time slot configuration
- Created migration 20260212120000_add_delivery_time_slots.sql with RLS policies
- Uses useTenantContext for tenant isolation
- Uses TanStack Query with proper queryKeys
- Follows all FloraIQ coding conventions

## task-216: Create delivery runner performance tracking
- Created `src/hooks/useRunnerMetrics.ts` with three main hooks:
  - `useRunnerMetrics(options)`: Fetches individual runner performance metrics
  - `useWeeklyPerformanceReport(weekOffset)`: Generates weekly team performance reports
  - `useRunnerLeaderboard(options)`: Returns ranked list of runners by composite score
- Metrics tracked:
  - Deliveries completed (total and weekly)
  - Average delivery time (from pickup to delivery)
  - On-time rate (within 60 minutes threshold)
  - Customer ratings (from runner.rating field)
  - Exceptions count (from delivery_exceptions table)
  - Distance covered (calculated via Haversine formula from location history)
  - Week-over-week change percentage
- Created supporting components:
  - `RunnerMetricsPanel`: Displays individual runner metrics (full and compact modes)
  - `WeeklyPerformanceReport`: Weekly team report with runner breakdown and insights
  - `RunnerLeaderboard`: Ranked runner list with period selector (week/month/all)
- Extended `queryKeys.runners` with `metrics`, `leaderboard`, and `weeklyReport` factories
- All queries filter by `tenant_id` via `useTenantContext()`
- Used `logger` from `@/lib/logger` for all debug/error logging
- Composite score formula: 30% deliveries + 30% on-time + 20% avg time + 20% rating
- Error handling for missing tables (delivery_exceptions, runner_location_history)
- Components export from `src/components/admin/delivery/index.ts`

## task-210: Create Supabase migration for delivery_proofs table
- Migration file already exists at supabase/migrations/add_delivery_proofs.sql
- Contains: id, tenant_id, delivery_id, order_id, photo_url, signature_url, recipient_name, notes, location_lat, location_lng, captured_at, created_at
- RLS policies for tenant isolation implemented
- Marked as passes: true

## task-217: Create delivery compliance checks
- Four files implemented: types (`src/types/delivery-compliance.ts`), hook (`src/hooks/useDeliveryCompliance.ts`), component (`src/components/admin/delivery/DeliveryComplianceChecklist.tsx`), migration (`supabase/migrations/20260212130000_create_delivery_compliance_checks.sql`)
- Six compliance check types: age_verification, id_on_file, licensed_zone, time_restriction, quantity_limit, customer_status
- Hook provides: fetch checks, create/verify/override mutations, batch initialization, auto-verify system checks, can_complete_delivery RPC
- Component features: progress bar, collapsible check details, manual verify/fail buttons, admin override dialog with reason, audit log viewer, blocking alert
- Migration includes: delivery_compliance_checks table, delivery_compliance_audit_log table, RLS policies, trigger-based audit logging, can_complete_delivery RPC function
- Fixed rule violations: changed .single() to .maybeSingle() (3 occurrences), fixed import ordering (React -> Third-party -> Types -> Components -> Utils), removed unused queryKeys import, moved sonner import to third-party group, separated DEFAULT_COMPLIANCE_SETTINGS value import from type imports
- Exported DeliveryComplianceChecklist from delivery barrel file (index.ts)
- TypeScript compilation passes with no errors
- Marked as passes: true

## Product Grid section edit dialog has all fields and saves correctly
- Updated ProductGridEditor in SectionEditors.tsx with new "Grid Settings" accordion section
- Added fields: columns (2/3/4), max_products (4-50), sort_order (newest/price/name), category_filter (all/flower/edibles/pre-rolls/concentrates/vapes), show_view_all_link toggle
- Updated sectionDefaults() in storefront-builder.config.ts to include new default values for all product grid content fields
- Updated ProductGridSectionProps interface with new fields: columns, max_products, sort_order, show_view_all_link, category_filter
- Updated ProductGridSection component to apply: category filtering, sort ordering, max product limits, dynamic grid columns, and "View All Products" button when products exceed max
- TypeScript compilation passes with zero errors

## Live Orders notification sound on new order with settings toggle
- Added synthesized tone fallback to `src/lib/soundAlerts.ts` using Web Audio API oscillators
  - When MP3 files are unavailable (no `/public/sounds/*.mp3` present), the system now plays synthesized tones instead of silently failing
  - `newOrder`: Two-tone ascending chime (C5 → E5) — distinct and attention-grabbing
  - `success`: Quick ascending ding (A5)
  - All other types: Default notification beep (F#5)
  - Volume-controlled via gain node, consistent with existing volume settings
- Fixed `StorefrontLiveOrders.tsx` sound toggle to persist to localStorage
  - Changed `useState(true)` → `useState(isSoundEnabled)` to load saved preference
  - Toggle now calls `persistSoundEnabled()` to save state via `STORAGE_KEYS.SOUND_ALERTS_ENABLED`
  - Toggle also calls `initAudio()` to ensure AudioContext is initialized on interaction
  - Button now uses `variant={soundEnabled ? 'default' : 'outline'}` for visual feedback (matches LiveOrders.tsx pattern)
- Both LiveOrders.tsx and StorefrontLiveOrders.tsx now share the same persisted sound preference
- TypeScript compilation passes with zero errors
## StorefrontPage renders all sections from layout_config in correct order
- Verified StorefrontPage component at src/pages/shop/StorefrontPage.tsx already has complete section rendering logic
- SECTION_COMPONENTS map covers all 14 section types: hero, features, product_grid, testimonials, newsletter, gallery, faq, custom_html, hot_items, promotions_banner, deals_highlight, luxury_hero, luxury_products, luxury_features
- Sections render in layout_config array order with data-section-type and data-section-index attributes
- Sections with visible=false are filtered out before rendering
- Default fallback layout (hero + deals + hot items + products) renders when layout_config is null/empty
- SEO structured data (JSON-LD) generates from store info
- AnnouncementBar renders independently above sections
- ShareButtons bar renders below sections
- Fixed vitest.config.ts to exclude .ralphy-sandboxes directory from test runs
- Fixed test mocks: added sanitizeWithLineBreaks and sanitizeHtml to sanitize mock
- Fixed framer-motion mock to use Proxy-based approach supporting all motion.* elements (not just div/h1/p)
- Fixed 404 error message test to match actual component text ("taken offline" not "no longer available")
- Fixed skeleton loader test to use role="status" selector matching actual Skeleton component
- Fixed empty products test to use data-testid="empty-product-grid" selector
- Added new test: verifies sections render in correct order via data-section-index attributes
- Added new test: verifies sections with visible=false are skipped
- All 29 tests pass, TypeScript compilation clean
## ShopLayout age verification gate for cannabis stores
- Rewrote StorefrontAgeGate as a presentational full-page overlay component with props (storeName, logoUrl, minimumAge, primaryColor, onVerify)
- Removed broken self-querying logic from StorefrontAgeGate (was querying non-existent enable_age_gate/age_gate_min_age columns)
- ShopLayout now uses StorefrontAgeGate for default theme and LuxuryAgeVerification for luxury theme
- Simplified LuxuryAgeVerification to be a pure presentational component (removed internal localStorage management)
- ShopLayout owns all age verification state: checks require_age_verification flag, persists per store slug in localStorage
- Removed redundant StorefrontAgeGate instances from bottom of both layout renders (unreachable after inline gate)
- "No" redirects to google.com, "Yes" saves to localStorage and shows store
- Preview mode bypasses age gate
## Checkout Step 1: Customer Info Form with React Hook Form + Zod
- Created `src/components/shop/CheckoutCustomerInfoStep.tsx` as extracted Step 1 component
- Uses React Hook Form + Zod validation (per project conventions)
- Fields: first name (required), last name (required), phone (required, validated with regex), email (optional), preferred contact method radio (Text/Phone/Email/Telegram)
- Includes create account option with conditional password field (min 8 chars)
- Integrates with returning customer auto-fill (useReturningCustomerLookup)
- Exposes validation function to parent via callback ref for step navigation
- Updated CheckoutPage.tsx to use the new component, replacing inline Step 1 JSX
- Made validateStep and nextStep async to support React Hook Form async validation
- Removed dead code: showErrors state, EMAIL_REGEX, PHONE_REGEX (from CheckoutPage)
## Post-checkout confirmation popup before navigation
- Created `src/components/shop/PostCheckoutConfirmationDialog.tsx` — modal shown immediately after successful order placement
- Dialog displays: success checkmark icon, "Order Confirmed!" title, thank-you message with order number, tenant Telegram link button (if configured), and "View Order Details" button
- Auto-closes after 10 seconds with visible countdown, then navigates to order confirmation page
- Integrated into `src/pages/shop/CheckoutPage.tsx` — onSuccess stores order data in state and shows popup instead of navigating immediately
- Integrated into `src/components/shop/SinglePageCheckout.tsx` — same pattern, shows popup before navigation
- Uses store primary color for theming, shadcn Dialog component
## Live Orders order detail slide-over panel with full info
- Created `src/components/admin/live-orders/LiveOrderDetailPanel.tsx` — right-side Sheet panel with full order details
- Fetches complete order data on demand when panel opens (from `orders` + `order_items` for app orders, `menu_orders` + parsed items for menu orders)
- Sections: header with order # and status badge, action buttons (next status + cancel), customer info, fulfillment/delivery address, line items table, price breakdown (subtotal/delivery/discount/tip/total), payment method with status, notes (delivery/special/customer), menu info for menu orders, timeline, footer with call customer and print actions
- Wired into `LiveOrdersKanban.tsx` — clicking a kanban card opens the detail panel
- Added `onViewDetails` callback prop to `LiveOrdersKanban` and `KanbanCard` components
- Added click stop propagation on action buttons row to prevent card click when using buttons
- Integrated into `LiveOrders.tsx` with `selectedOrder` and `detailPanelOpen` state management
- Uses `queryKeys.orders.detail()` for TanStack Query caching with 30s stale time
- All Supabase queries filter by `tenant_id` for multi-tenant isolation
- Uses `.maybeSingle()` for optional data fetching
- Follows all FloraIQ coding standards: logger, @/ imports, sonner toast, shadcn/ui components
- TypeScript compilation passes with zero errors
