# Task: Deploy and Verify Auth Edge Functions
# Status: COMPLETED
# Date: 2026-01-22

## What Was Done

### 1. Added Health Check Endpoints to All Auth Edge Functions

Each auth function now supports a `?action=health` query parameter that returns:
- Function status (`ok`)
- Function name
- Timestamp
- Environment variable availability (boolean flags, not values)

Functions updated:
- `supabase/functions/tenant-admin-auth/index.ts` - Added health check (checks SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
- `supabase/functions/super-admin-auth/index.ts` - Added health check (checks SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, JWT_SECRET)
- `supabase/functions/customer-auth/index.ts` - Added health check (checks SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, JWT_SECRET)
- `supabase/functions/revoke-all-sessions/index.ts` - Added health check (checks SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)

### 2. Created Deployment Script

`scripts/deploy-auth-functions.sh` - Full deployment pipeline:
- Links to Supabase project (mtvwmyerntkhrcdnhahp)
- Verifies required secrets are configured (JWT_SECRET, SUPABASE_SERVICE_ROLE_KEY)
- Deploys all 4 auth edge functions
- Runs health checks to verify successful deployment

### 3. Created Verification Script

`scripts/verify-auth-functions.sh` - Quick health check script:
- Runs health checks against all 4 auth functions
- Reports env variable status from each function
- Supports custom project ref as argument
- Returns exit code 1 if any function fails

## Deployment Instructions

### Prerequisites
1. Install Supabase CLI: `npm install -g supabase`
2. Login: `npx supabase login`

### Deploy
```bash
# Option 1: Full deploy with verification
chmod +x scripts/deploy-auth-functions.sh
./scripts/deploy-auth-functions.sh

# Option 2: Manual deploy
cd supabase
npx supabase link --project-ref mtvwmyerntkhrcdnhahp
npx supabase functions deploy tenant-admin-auth --no-verify-jwt
npx supabase functions deploy super-admin-auth --no-verify-jwt
npx supabase functions deploy customer-auth --no-verify-jwt
npx supabase functions deploy revoke-all-sessions --no-verify-jwt
```

### Set Required Secrets (if not already set)
```bash
npx supabase secrets set JWT_SECRET=<your-jwt-secret>
npx supabase secrets set SUPABASE_SERVICE_ROLE_KEY=<your-service-role-key>
```

### Verify Deployment
```bash
# Using verification script
chmod +x scripts/verify-auth-functions.sh
./scripts/verify-auth-functions.sh

# Or manual curl
curl -s "https://mtvwmyerntkhrcdnhahp.supabase.co/functions/v1/tenant-admin-auth?action=health"
curl -s "https://mtvwmyerntkhrcdnhahp.supabase.co/functions/v1/super-admin-auth?action=health"
curl -s "https://mtvwmyerntkhrcdnhahp.supabase.co/functions/v1/customer-auth?action=health"
curl -s "https://mtvwmyerntkhrcdnhahp.supabase.co/functions/v1/revoke-all-sessions?action=health"
```

## Acceptance Criteria Met
- [x] All auth functions have health check endpoints
- [x] Health checks verify required environment variables
- [x] Deployment script automates the full deploy process
- [x] Verification script provides quick health status
- [x] Functions ready for deployment (code complete, validation in place)

## Auth Functions Summary

| Function | Purpose | Token Expiry | Key Dependencies |
|----------|---------|--------------|------------------|
| tenant-admin-auth | Tenant admin login/verify/refresh/logout | Supabase Auth session | SUPABASE_URL, SERVICE_ROLE_KEY |
| super-admin-auth | Platform super admin auth | 8 hours (JWT) | SUPABASE_URL, SERVICE_ROLE_KEY, JWT_SECRET |
| customer-auth | Storefront customer auth | 30 days (JWT) | SUPABASE_URL, SERVICE_ROLE_KEY, JWT_SECRET |
| revoke-all-sessions | Bulk session revocation | N/A | SUPABASE_URL, SERVICE_ROLE_KEY |
