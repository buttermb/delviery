## Task: Fix Token Refresh Race Conditions

### What was done:

1. Created `src/lib/auth/tokenRefreshManager.ts` - A singleton TokenRefreshManager class that:
   - Prevents concurrent refresh requests via promise deduplication (same scope returns same promise)
   - Enforces minimum 5-second interval between refresh attempts to prevent rapid-fire
   - Supports isolated scopes ('tenant-admin', 'customer') so different auth contexts don't interfere
   - Provides `isRefreshing(scope)` check for other code to query refresh state
   - Provides `reset(scope)` and `resetAll()` for cleanup during logout
   - Properly handles errors in the finally block so state is always cleaned up

2. Updated `src/contexts/TenantAdminAuthContext.tsx`:
   - Replaced inline `isRefreshingRef`/`refreshPromiseRef` guards with `tokenRefreshManager.refresh('tenant-admin', ...)`
   - Fixed `verifyToken` which previously did an inline refresh via `resilientFetch` that bypassed the race guard - now delegates to `refreshAuthToken()` which goes through the manager
   - Added guard in `onAuthStateChange` to skip token updates while a managed refresh is in progress (prevents stale tokens from overwriting newer ones)
   - Added `tokenRefreshManager.reset('tenant-admin')` to `clearAuthState` for proper cleanup on logout

3. Updated `src/contexts/CustomerAuthContext.tsx`:
   - Added race condition protection to `refreshToken` using `tokenRefreshManager.refresh('customer', ...)`
   - Previously had no concurrency protection - overlapping interval checks could trigger multiple verifications
   - Added `tokenRefreshManager.reset('customer')` to logout cleanup

4. Updated `src/lib/auth/__tests__/tokenRefresh.test.ts`:
   - Replaced old inline race condition tests with comprehensive tests for the TokenRefreshManager pattern
   - Added tests for: deduplication, scope isolation, error handling, isRefreshing state, minimum interval enforcement, reset behavior
   - All 22 tests pass

5. Fixed pre-existing build error in `src/lib/utils/sanitize.ts`:
   - Added missing `sanitizeBasicHtml` export that was referenced by HeroSection.tsx

### Race Conditions Fixed:
- [x] Multiple simultaneous `refreshAuthToken` calls now deduplicated via singleton manager
- [x] `verifyToken` inline refresh no longer bypasses the race guard
- [x] `onAuthStateChange` no longer overwrites tokens during an active refresh
- [x] Customer auth concurrent verify calls now protected
- [x] Minimum interval prevents rapid-fire refresh attempts after errors
- [x] Logout properly resets refresh state to prevent stale attempts

### Files Changed:
- `src/lib/auth/tokenRefreshManager.ts` (new)
- `src/contexts/TenantAdminAuthContext.tsx` (modified)
- `src/contexts/CustomerAuthContext.tsx` (modified)
- `src/lib/auth/__tests__/tokenRefresh.test.ts` (modified)
- `src/lib/utils/sanitize.ts` (modified - pre-existing build fix)

---

## Task: Fix Session Persistence on Page Reload

### What was done:

1. Fixed `src/contexts/AuthContext.tsx`:
   - Set up `onAuthStateChange` listener BEFORE calling `getSession()` to catch the `INITIAL_SESSION` event that Supabase fires when restoring a session from localStorage
   - Added `initializedRef` to prevent duplicate loading state resolution
   - The `getSession()` call now serves as a fallback only (for edge cases where `onAuthStateChange` doesn't fire)
   - This eliminates the race condition where `loading=true` and `user=null` would cause downstream components to show unauthenticated UI

2. Fixed `src/contexts/TenantAdminAuthContext.tsx`:
   - Added synchronous localStorage hydration on initial render using `useState` initializers
   - State is now pre-populated from localStorage immediately (no async gap)
   - `isAuthenticated` starts as `true` if valid stored session data exists
   - `loading` starts as `false` if stored session data exists (no loading spinner flash)
   - Changed initialization effect dependency from `[location.pathname]` to `[]` (runs once)
   - Added `authInitializedRef` to prevent wasteful re-initialization on route changes
   - `clearAuthState()` resets `authInitializedRef` to allow re-initialization after logout
   - Background verification still runs to validate the stored session, but UI renders immediately

3. Fixed `src/lib/utils/sanitize.ts` (pre-existing build error):
   - Added `sanitizeBasicHtml` export alias for `sanitizeHtml` (was referenced by HeroSection.tsx but not exported)

### Acceptance Criteria Met:
- [x] Page reload maintains logged-in state (synchronous hydration from localStorage)
- [x] No flash of login screen for authenticated users (loading=false when stored session exists)
- [x] Session persists across browser tabs (localStorage-based hydration + Supabase session sync)

### Files Changed:
- `src/contexts/AuthContext.tsx` (modified - proper session restoration order)
- `src/contexts/TenantAdminAuthContext.tsx` (modified - synchronous hydration, single init)
- `src/lib/utils/sanitize.ts` (modified - export alias fix)

---

## Task: Add Breadcrumb Navigation Between Panels

### What was done:

1. Created `src/lib/auth/logoutCleanup.ts` - A centralized logout cleanup utility that:
   - Clears TanStack Query cache (`queryClient.clear()`) to prevent stale data leaking between sessions
   - Destroys client encryption session (keys from memory + session storage)
   - Clears tier-specific localStorage keys (tokens, user data, tenant info)
   - Clears shared session keys (`floraiq_user_id`, `lastTenantSlug`) from both localStorage and sessionStorage
   - Provides `broadcastLogout()` helper for cross-tab synchronization
   - Supports all 5 auth tiers: super_admin, tenant_admin, customer, vendor, base

2. Updated `src/contexts/TenantAdminAuthContext.tsx`:
   - Added `useQueryClient` hook and `performLogoutCleanup` import
   - Replaced manual cleanup in `logout()` with centralized `performLogoutCleanup()`
   - Updated cross-tab logout handler to also clear query cache via `performLogoutCleanup()`
   - Replaced inline BroadcastChannel code with `broadcastLogout()` helper

3. Updated `src/contexts/SuperAdminAuthContext.tsx`:
   - Added `useQueryClient` hook and `performLogoutCleanup` import
   - Replaced manual encryption destroy + storage cleanup with `performLogoutCleanup()`
   - Fixed duplicate `safeStorage.removeItem('floraiq_user_id')` call
   - Now properly clears query cache on logout

4. Updated `src/contexts/CustomerAuthContext.tsx`:
   - Added `useQueryClient` hook and `performLogoutCleanup` import
   - Replaced manual encryption destroy + storage cleanup with `performLogoutCleanup()`
   - Customer-specific keys (cart, checkout data, customer mode) now properly cleared
   - Fixed duplicate `safeStorage.removeItem('floraiq_user_id')` call

5. Updated `src/contexts/VendorAuthContext.tsx`:
   - Added `useQueryClient` hook, `performLogoutCleanup` import
   - Added try/catch error handling around `supabase.auth.signOut()`
   - Added encryption session destruction (was completely missing)
   - Added query cache clearing (was completely missing)
   - Added storage cleanup (was completely missing)

6. Updated `src/contexts/AuthContext.tsx`:
   - Added `useQueryClient` hook and `performLogoutCleanup` import
   - Replaced manual `clientEncryption.destroy()` + storage removal with `performLogoutCleanup()`
   - Now properly clears query cache on sign out

7. Fixed pre-existing build error in `src/lib/utils/sanitize.ts`:
   - Added missing `sanitizeBasicHtml` export (used by HeroSection but was never defined)

### Key Improvements:
- **Query cache clearing**: All auth contexts now clear the TanStack Query cache on logout, preventing stale data from a previous session showing up when a different user logs in
- **Consistent cleanup**: All 5 auth tiers use the same centralized cleanup logic
- **VendorAuthContext hardened**: Was previously missing encryption destroy, storage cleanup, error handling, and query cache clearing
- **Reduced duplication**: Removed duplicate storage removal calls and inline cleanup code
- **Cross-tab logout**: BroadcastChannel logic extracted to reusable `broadcastLogout()` helper

### Acceptance Criteria Met:
- [x] All auth contexts clear TanStack Query cache on logout
- [x] Encryption sessions destroyed consistently across all tiers
- [x] Storage keys cleaned up per tier (tokens, user data, tenant info)
- [x] Shared session keys cleared (floraiq_user_id, lastTenantSlug)
- [x] Cross-tab logout synchronization maintained
- [x] VendorAuthContext brought to parity with other auth contexts
- [x] Build passes with no TypeScript errors

### Files Changed:
- `src/lib/auth/logoutCleanup.ts` (new)
- `src/contexts/TenantAdminAuthContext.tsx` (modified)
- `src/contexts/SuperAdminAuthContext.tsx` (modified)
- `src/contexts/CustomerAuthContext.tsx` (modified)
- `src/contexts/VendorAuthContext.tsx` (modified)
- `src/contexts/AuthContext.tsx` (modified)
- `src/lib/utils/sanitize.ts` (modified - pre-existing build fix)
