# Task: Complete Storefront Checkout with Stripe

## Status: COMPLETED

## Changes Made

### 1. Fixed Stripe Checkout Item Payload (CheckoutPage.tsx)
- Added `product_id` field to checkout items sent to the `storefront-checkout` edge function
- Previously only sent `name`, `price`, `quantity`, `image_url` - but the edge function requires `product_id` for server-side price verification
- Removed client `price` from the payload since the edge function ignores it (security best practice)

### 2. Added Discount Support to Stripe Session
- CheckoutPage now calculates total discount (coupon + loyalty + deals) and sends `discount_amount` to the edge function
- Edge function creates a Stripe coupon on-the-fly to apply the discount to the checkout session
- Discount is capped at subtotal to prevent negative charges

### 3. Fixed Cart Clearing for Card Payments
- Cart is now cleared before redirecting to Stripe checkout (since order is already created at that point)
- Previously cart was only cleared for cash/other payment methods after order placement
- Prevents duplicate orders if user returns and tries to checkout again

### 4. Added Stripe Session ID to Success URL
- Success URL now includes `{CHECKOUT_SESSION_ID}` template parameter (Stripe replaces with actual session ID)
- OrderConfirmationPage reads session_id from URL params for payment verification

### 5. Enhanced OrderConfirmationPage with Payment Verification
- Added Stripe payment status verification when redirected from Stripe checkout
- Shows loading spinner while verifying payment
- Checks storefront_orders table for payment_status or matching stripe_session_id
- Gracefully handles cases where webhook hasn't arrived yet (shows confirmation anyway)

### 6. Added Cancelled Payment Handling
- Cancel URL now includes `?cancelled=true` parameter
- CheckoutPage detects the cancelled parameter and shows a toast notification
- Cleanly removes the parameter from URL after showing the message

### 7. Converted to Named Exports (Code Style Compliance)
- CheckoutPage: Changed from `export default function` to `export function`
- OrderConfirmationPage: Changed from `export default function` to `export function`
- Updated index.ts barrel exports to use `{ CheckoutPage }` and `{ OrderConfirmationPage }` instead of `{ default as ... }`

### 8. Created Missing sanitize.ts Utility
- Created `src/lib/utils/sanitize.ts` with `sanitizeHtml()` function
- Strips script/iframe/object/embed/form tags
- Removes event handler attributes (onclick, onload, etc.)
- Blocks javascript:/vbscript:/data: protocol URIs
- Adds `rel="noopener noreferrer"` to target="_blank" links
- Required by ProductDetailPage and CustomHTMLSection (was missing, blocking build)

### 9. Updated storefront-checkout Edge Function
- Added `discount_amount` to CheckoutRequest interface
- Creates a one-time Stripe coupon when discount is present
- Applies discount via Stripe's `discounts` parameter on session creation
- Added proper spread of discounts into session config

## Files Modified
- `src/pages/shop/CheckoutPage.tsx` - Stripe integration fixes, named export, cancelled handling
- `src/pages/shop/OrderConfirmationPage.tsx` - Payment verification, named export
- `src/pages/shop/index.ts` - Updated barrel exports
- `supabase/functions/storefront-checkout/index.ts` - Discount support, updated request interface
- `src/lib/utils/sanitize.ts` (NEW) - HTML sanitization utility

## Build Status
- `npm run build` passes cleanly (6530 modules, no TypeScript errors)
