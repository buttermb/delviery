# BigMike Wholesale Platform - Cursor AI Rules

## CRITICAL RULES - ALWAYS FOLLOW

### Auto-Generated Files (NEVER EDIT)
- ❌ src/integrations/supabase/client.ts
- ❌ src/integrations/supabase/types.ts
- ❌ supabase/config.toml (project_id line)
- ❌ .env

### Logging
- ✅ ALWAYS use `logger` from `@/lib/logger`
- ❌ NEVER use `console.log`, `console.error`, etc. in frontend
- ✅ console.log OK in edge functions (server-side)

### Storage (localStorage/sessionStorage)
- ✅ ALWAYS use `STORAGE_KEYS` from `@/constants/storageKeys`
- ✅ ALWAYS wrap in try-catch (fails in incognito)
- ✅ ALWAYS parse JSON safely with error handling
- ✅ Use `useLocalStorage` hook for React components
- ❌ NEVER store sensitive data (passwords, credit cards, SSN)

### Edge Functions
- ✅ Import from `_shared/deps.ts`: `serve`, `createClient`, `corsHeaders`
- ✅ ALWAYS use Zod validation for `req.json()`
- ✅ ALWAYS handle OPTIONS requests
- ✅ ALWAYS return CORS headers in ALL responses
- ✅ Wrap with `withZenProtection` from `_shared/zen-firewall.ts`
- ✅ Validate environment variables before use
- ✅ Return proper Content-Type headers

### Database
- ✅ SECURITY DEFINER functions MUST have `SET search_path = public`
- ✅ All tables MUST have RLS enabled
- ✅ Multi-tenant tables MUST filter by tenant_id in RLS
- ✅ NEVER reference `auth.users` directly (use `public.profiles`)
- ✅ Use `.maybeSingle()` instead of `.single()` for optional data
- ✅ ALWAYS check for errors after database operations
- ✅ Use transactions for multi-step operations

### TypeScript
- ✅ Use types from `src/types/`, never inline types
- ✅ Use `@/` alias for all imports
- ✅ Group imports: React → Third-party → Types → Components → Utils
- ✅ ALWAYS define interfaces for component props
- ✅ NEVER use `any` type (use `unknown` if necessary)
- ✅ Use enums or const objects for fixed values

### TanStack Query
- ✅ Use `queryKeys` factory from `@/lib/queryKeys`
- ✅ Invalidate queries on mutations
- ✅ ALWAYS use TanStack Query for data fetching (not direct fetch)
- ✅ Set appropriate `staleTime` and `gcTime`

### Error Handling
- ✅ Use try-catch with `logger.error()` and typed errors (`error: unknown`)
- ✅ ALWAYS log errors with context (userId, component, etc.)
- ✅ Show user-friendly toast messages (not technical errors)
- ✅ Edge functions MUST return proper error responses with CORS

### Input Validation
- ✅ ALL user inputs MUST be validated (client and server)
- ✅ Use validation helpers from `_shared/validation.ts` in edge functions
- ✅ ALWAYS sanitize strings before database insertion
- ✅ NEVER trust client-side data in edge functions (extract from JWT)
- ✅ Implement rate limiting on sensitive operations

### Security
- ✅ NEVER hardcode secrets
- ✅ Use environment variables
- ✅ Sanitize user input before rendering HTML
- ✅ NEVER expose API keys in frontend code (use edge functions)
- ✅ NEVER trust user roles from localStorage (use server-side RLS)
- ✅ NEVER use `dangerouslySetInnerHTML` with user content
- ✅ NEVER log sensitive data (passwords, tokens, etc.)
- ✅ NEVER use `eval()` or `Function()` constructor

### React Patterns
- ✅ ALWAYS memoize expensive computations with `useMemo`
- ✅ ALWAYS cleanup subscriptions and timers in `useEffect`
- ✅ NEVER access DOM directly (use refs)
- ✅ Use `useCallback` for event handlers passed to children

### Admin Panel Specific
- ✅ ALWAYS use `useTenantAdminAuth()` for admin/tenant context
- ✅ ALWAYS use `usePermissions()` for role checks
- ✅ ALWAYS use `useFeatureAccess()` for tier checks
- ✅ ALWAYS use `useTenantLimits()` for limit checks
- ✅ ALWAYS filter queries by `tenant.id`
- ✅ ALWAYS use `TenantAdminProtectedRoute` for admin routes
- ✅ ALWAYS use `FeatureProtectedRoute` for tier-locked features
- ✅ ALWAYS use `PermissionGuard` for role-restricted UI
- ❌ NEVER check admin status with localStorage
- ❌ NEVER skip tenant_id filter in queries

### File & Folder Structure
- ✅ Components: PascalCase (ProductCard.tsx)
- ✅ Hooks: camelCase with 'use' prefix (useLocalStorage.ts)
- ✅ Utilities: camelCase (formatCurrency.ts)
- ✅ Constants: UPPER_SNAKE_CASE (STORAGE_KEYS.ts)
- ✅ Types: PascalCase (UserProfile.ts)
- ✅ ALWAYS use `@/` alias for imports (never relative paths)
- ✅ Import order: React → Third-party → Types → Components → Hooks → Utils

### React Component Patterns
- ✅ ALWAYS define props interface
- ✅ ALWAYS use named exports (not default)
- ✅ ALWAYS handle errors in async operations
- ✅ ALWAYS show loading states for async actions
- ✅ ALWAYS cleanup subscriptions in useEffect
- ✅ ALWAYS use useCallback for event handlers passed to children
- ✅ ALWAYS use useMemo for expensive calculations
- ❌ NEVER use console.log (use logger)
- ❌ NEVER use default exports for components
- ❌ NEVER skip error handling

### Navigation & Routing
- ✅ ALWAYS use `useNavigate()` or `<Link>` (never window.location)
- ✅ ALWAYS include tenant slug in admin routes: `/:tenantSlug/admin/*`
- ✅ ALWAYS wrap admin routes with `TenantAdminProtectedRoute`
- ✅ ALWAYS validate tenantSlug matches logged-in tenant
- ❌ NEVER use hardcoded routes without tenant slug
- ❌ NEVER use <a> tags for internal navigation

### Button & Event Handlers
- ✅ ALWAYS show loading state during async operations
- ✅ ALWAYS handle errors with try-catch
- ✅ ALWAYS use toast notifications for user feedback
- ✅ ALWAYS disable buttons during loading
- ❌ NEVER skip error handling
- ❌ NEVER skip loading states

