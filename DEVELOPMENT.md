# Development Guide - BigMike Wholesale Platform

## Quick Start

```bash
# Install dependencies
npm install

# Install Git hooks (recommended)
bash scripts/install-hooks.sh

# Start development server
npm run dev
```

## Git Hooks

This project uses Git hooks to enforce code quality and security standards before pushing to GitHub.

### Installing Hooks

```bash
bash scripts/install-hooks.sh
```

### Pre-Push Validation

The pre-push hook automatically validates:

1. ‚úÖ **Auto-generated files** - Blocks edits to:
   - `src/integrations/supabase/client.ts`
   - `src/integrations/supabase/types.ts`
   - `supabase/config.toml`
   - `.env`

2. ‚úÖ **Console statements** - No `console.log` (use `logger` utility)

3. ‚úÖ **Hardcoded secrets** - Detects API keys, passwords, tokens

4. ‚úÖ **Database migrations**:
   - SECURITY DEFINER functions must have `SET search_path = public`
   - No modifications to reserved schemas (auth, storage, realtime, vault)
   - No foreign keys to `auth.users` (use `public.profiles`)

5. ‚úÖ **Edge functions**:
   - Zod validation for all `req.json()` calls
   - CORS OPTIONS handling
   - Shared dependencies import

6. ‚úÖ **TypeScript** - Type checking with `tsc --noEmit`

7. ‚úÖ **Linting** - ESLint validation

8. ‚úÖ **Build** - Ensures `npm run build` succeeds

9. ‚úÖ **Commit messages** - Conventional commit format

### Bypassing Hooks

**Not recommended**, but if needed:

```bash
git push --no-verify
```

## Critical Rules

### üö´ NEVER Edit These Files

These are auto-generated by Supabase and will be overwritten:

```
src/integrations/supabase/client.ts
src/integrations/supabase/types.ts
supabase/config.toml (project_id section)
.env
```

### üîí Database Security Rules

**SECURITY DEFINER Functions:**
```sql
CREATE OR REPLACE FUNCTION has_role(role_name text)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public  -- ‚ö†Ô∏è CRITICAL: Always include this!
AS $$
BEGIN
  -- function body
END;
$$;
```

**RLS Policies:**
```sql
-- Enable RLS on all tables
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;

-- Multi-tenant isolation
CREATE POLICY "tenant_isolation" ON public.products
  FOR ALL
  USING (tenant_id = auth.jwt() ->> 'tenant_id');
```

**Foreign Keys:**
```sql
-- ‚úÖ CORRECT: Reference public.profiles
FOREIGN KEY (user_id) REFERENCES public.profiles(id)

-- ‚ùå WRONG: Never reference auth.users
FOREIGN KEY (user_id) REFERENCES auth.users(id)
```

### üõ°Ô∏è Edge Function Rules

**Zod Validation (MANDATORY):**
```typescript
import { z } from 'zod';

const requestSchema = z.object({
  email: z.string().email(),
  name: z.string().min(1).max(100),
});

// Validate ALL req.json() calls
const body = requestSchema.parse(await req.json());
```

**CORS Handling:**
```typescript
// Handle OPTIONS preflight
if (req.method === 'OPTIONS') {
  return new Response(null, { headers: corsHeaders });
}

// Include CORS in all responses
return new Response(
  JSON.stringify(data),
  { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
);
```

**Password Hashing:**
```typescript
import * as bcrypt from 'bcrypt';

// ‚úÖ CORRECT: bcrypt with 12 rounds
const hashedPassword = await bcrypt.hash(password, 12);

// ‚ùå WRONG: SHA-256 is not suitable for passwords
```

### üé® Frontend Rules

**Logging:**
```typescript
// ‚úÖ CORRECT: Use logger utility
import { logger } from '@/utils/logger';
logger.info('User logged in', { userId: user.id });

// ‚ùå WRONG: Never use console.log
console.log('User logged in');
```

**Imports:**
```typescript
// ‚úÖ CORRECT: Use @ alias
import { Button } from '@/components/ui/button';

// ‚ùå WRONG: Relative paths
import { Button } from '../../../components/ui/button';
```

**Types:**
```typescript
// ‚úÖ CORRECT: Use defined types
import { Product } from '@/types/product';

// ‚ùå WRONG: Inline types or any
const product: any = { ... };
```

## Build Requirements

**Heap Size:** Build requires 4GB heap size

```bash
export NODE_OPTIONS="--max-old-space-size=4096"
npm run build
```

This is handled automatically by the pre-push hook.

## Testing

```bash
# Run all tests
npm test

# Type checking
npx tsc --noEmit

# Linting
npm run lint

# Build test
npm run build
```

## Conventional Commits

Format: `type(scope): description`

**Types:**
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation
- `style`: Formatting, missing semicolons, etc.
- `refactor`: Code restructuring
- `perf`: Performance improvements
- `test`: Adding tests
- `chore`: Maintenance tasks
- `build`: Build system changes
- `ci`: CI/CD changes

**Examples:**
```
feat(auth): add password reset flow
fix(products): resolve SKU duplicate validation
docs(readme): update installation instructions
refactor(cart): extract checkout logic to hook
```

## Security Checklist

Before pushing:

- [ ] No console.log statements
- [ ] No hardcoded secrets or API keys
- [ ] SECURITY DEFINER functions have `SET search_path = public`
- [ ] No foreign keys to `auth.users`
- [ ] RLS enabled on all tables
- [ ] Multi-tenant tables filter by `tenant_id`
- [ ] Edge functions have Zod validation
- [ ] Edge functions handle CORS
- [ ] Passwords use bcrypt (12 rounds)
- [ ] Auto-generated files not modified
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] All tests pass

## Resources

- [Project Documentation](./README.md)
- [Security Settings](./SECURITY_SETTINGS.md)
- [Commit Message Guide](./COMMIT_MESSAGE.md)
- [Code Quality Review](./CODE_QUALITY_REVIEW_COMPLETE.md)
- [Supabase Integration Rules](./docs/SUPABASE_RULES.md)

## Getting Help

If validation fails:
1. Read the error message carefully
2. Review the relevant section in this guide
3. Check the specific file mentioned
4. Fix the issue and try again

To bypass (emergency only):
```bash
git push --no-verify
```

**Note:** Bypassing should only be used in emergencies and requires careful review.
